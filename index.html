<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Explorador de Armonía e Improvisación (Sistema Harris)</title>
    <!-- Cargar Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos personalizados para el piano */
        .piano-container {
            position: relative;
            width: 100%; /* Ajusta el ancho para que quepa en el contenedor */
            height: 140px; /* Reduje la altura para que las negras queden bien */
            background-color: #333; /* Fondo oscuro del piano */
            border-radius: 5px;
            overflow: hidden;
            box-shadow: inset 0 -2px 5px rgba(0,0,0,0.5);
            padding-left: 5px; /* Pequeño padding para el inicio */
            padding-right: 5px;
            box-sizing: border-box; /* Para incluir padding en el ancho */
        }
        .key-group {
            position: relative;
            height: 100%;
            display: flex;
        }
        .white-key {
            background-color: white;
            border: 1px solid #ccc;
            border-top: none;
            width: 40px; /* Ancho de tecla blanca ajustado */
            height: 100%;
            position: absolute; /* CORREGIDO: Debe ser absolute */
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            z-index: 1; /* Las blancas debajo de las negras */
            display: flex; /* Para alinear la etiqueta */
            justify-content: center;
            align-items: flex-end;
            padding-bottom: 5px;
            box-sizing: border-box;
            color: #333;
            font-size: 10px;
            font-weight: bold;
        }
        .black-key {
            background-color: #333;
            border: 1px solid #222;
            border-top: none;
            width: 25px; /* Ancho de tecla negra ajustado */
            height: 65%; /* Altura de la tecla negra */
            position: absolute;
            top: 0;
            z-index: 2; /* Las negras encima de las blancas */
            box-shadow: 0 1px 3px rgba(0,0,0,0.5);
            border-radius: 0 0 3px 3px;
        }

        /* Colores de resaltado */
        .highlighted { background-color: #06b6d4; } /* Cyan 600 */
        .highlighted-bass { background-color: #f97316; } /* Orange 500 */
        .highlighted-extra { background-color: #fbbf24; } /* Amber 400 */ /* Para notas extras */
        
        .white-key.highlighted { background-color: #06b6d4; color: white; }
        .black-key.highlighted { background-color: #06b6d4; }
        .white-key.highlighted-bass { background-color: #f97316; color: white; }
        .black-key.highlighted-bass { background-color: #f97316; }
        .white-key.highlighted-extra { background-color: #fbbf24; color: black; } /* Amber */
        .black-key.highlighted-extra { background-color: #fbbf24; } /* Amber */


        /* Etiqueta de nota */
        .note-label {
            pointer-events: none; /* Para que no interfiera con los clics */
        }

        /* Display de notas */
        .note-display {
            text-align: center;
            color: #cbd5e1; /* gray-300 */
            font-size: 0.875rem;
            margin-top: 0.75rem;
            height: 1.25rem; /* Altura fija para evitar saltos */
        }

        /* Deshabilitar botones */
        .nav-button:disabled, .control-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Para el scroll horizontal */
        .piano-scroll-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch; /* Para un scroll más suave en móviles */
        }

        /* Estilos de Pestañas */
        .tab-button {
            padding: 0.75rem 1rem; /* Ajustado el padding */
            border-radius: 0.5rem 0.5rem 0 0;
            background-color: #374151; /* gray-700 */
            color: #d1d5db; /* gray-300 */
            border: 1px solid #4b5563; /* gray-600 */
            border-bottom: none;
            cursor: pointer;
            font-weight: 600;
            white-space: nowrap; /* Evita que el texto se parta */
            font-size: 0.875rem; /* Reducido el tamaño de fuente */
        }
        @media (min-width: 640px) { /* sm */
             .tab-button {
                padding: 0.75rem 1.5rem;
                font-size: 1rem;
             }
        }
        .tab-button.active {
            background-color: #1f2937; /* gray-800 */
            color: #67e8f9; /* cyan-300 */
            border-bottom: 1px solid #1f2937; /* Para que se fusione con el fondo */
            position: relative;
            top: 1px;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }

        /* NUEVO: Estilo para botones de inversión */
        .inv-button {
             background-color: #4b5563; /* gray-600 */
             color: white;
             font-size: 0.875rem;
             padding: 0.5rem 0.75rem;
             border-radius: 0.375rem;
             flex: 1 1 0%;
             transition: background-color 0.2s;
        }
        .inv-button:hover {
            background-color: #6b7280; /* gray-500 */
        }

        /* Estilos para la pestaña de improvisación */
        #page-improvisation h3 {
            font-size: 1.5rem; /* text-2xl */
            font-weight: 600; /* font-semibold */
            color: #67e8f9; /* cyan-300 */
            margin-bottom: 1rem; /* mb-4 */
            border-bottom: 1px solid #4b5563; /* border-b border-gray-600 */
            padding-bottom: 0.5rem; /* pb-2 */
        }
        #page-improvisation h4 {
            font-size: 1.125rem; /* text-lg */
            font-weight: 600; /* font-semibold */
            color: #e5e7eb; /* gray-200 */
            margin-top: 1.5rem; /* mt-6 */
            margin-bottom: 0.75rem; /* mb-3 */
        }
        #page-improvisation p {
            color: #d1d5db; /* gray-300 */
            margin-bottom: 1rem; /* mb-4 */
            line-height: 1.6;
        }
        #page-improvisation ul {
            list-style-type: disc;
            margin-left: 1.5rem; /* ml-6 */
            margin-bottom: 1rem; /* mb-4 */
            color: #d1d5db; /* gray-300 */
        }
        #page-improvisation li {
            margin-bottom: 0.5rem; /* mb-2 */
        }
        #page-improvisation strong {
             color: #93c5fd; /* blue-300 */
        }
        #page-improvisation code {
            background-color: #374151; /* gray-700 */
            padding: 0.1rem 0.4rem;
            border-radius: 0.25rem;
            font-family: monospace;
            color: #fde047; /* yellow-300 */
        }
        /* Contenedor para sección interactiva */
        .interactive-section {
            background-color: #111827; /* gray-900 */
            padding: 1.5rem;
            border-radius: 0.5rem;
            margin-top: 2rem;
            border: 1px solid #4b5563; /* gray-600 */
        }

    </style>
</head>
<body class="bg-gray-900 text-gray-100 font-sans p-4 md:p-8">

    <div class="max-w-4xl mx-auto">
        
        <!-- Título -->
        <h1 class="text-3xl font-bold text-center mb-2 text-cyan-300">Explorador de Armonía e Improvisación</h1>
        <h2 class="text-xl text-center text-gray-400 mb-6">Sistema de Barry Harris</h2>
        
        <!-- Pestañas de Navegación -->
        <div class="flex mb-0">
            <button id="tab-btn-251" class="tab-button active" data-tab="page-251">
                2-5-1 (Armonía)
            </button>
            <button id="tab-btn-diminished" class="tab-button" data-tab="page-diminished">
                Conceptos Fundamentales
            </button>
            <button id="tab-btn-improvisation" class="tab-button" data-tab="page-improvisation">
                Improvisación (Conceptos)
            </button>
        </div>

        <!-- =========== SECCIÓN 1: EXPLORADOR 2-5-1 =========== -->
        <div id="page-251" class="tab-content active bg-gray-800 p-6 rounded-b-lg rounded-tr-lg shadow-xl mb-6">
            <h2 class="text-xl text-center text-gray-400 mb-4">Sustituciones de Acordes 2-5-1</h2>

            <!-- Selector de Tonalidad -->
            <div class="mb-6 max-w-xs mx-auto">
                <label for="key-select-251" class="block text-sm font-medium text-gray-400 mb-2 text-center">Selecciona la Tonalidad (I):</label>
                <select id="key-select-251" class="bg-gray-700 border border-gray-600 text-white text-lg rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block w-full p-2.5">
                    <option value="C">C</option>
                    <option value="Db">Db / C#</option>
                    <option value="D">D</option>
                    <option value="Eb">Eb</option>
                    <option value="E">E</option>
                    <option value="F" selected>F</option>
                    <option value="Gb">Gb / F#</option>
                    <option value="G">G</option>
                    <option value="Ab">Ab</option>
                    <option value="A">A</option>
                    <option value="Bb">Bb</option>
                    <option value="B">B / Cb</option>
                </select>
            </div>

            <!-- Tarjeta Principal del Concepto -->
            <div class="bg-gray-800 rounded-lg mb-6">
                
                <!-- Títulos del Concepto -->
                <h3 id="concept-title-251" class="text-2xl font-semibold text-white mb-2"></h3>
                <p id="concept-subtitle-251" class="text-lg text-cyan-400 mb-4"></p>
                <p id="concept-description-251" class="text-gray-300 mb-6"></p>

                <!-- Botones de Acordes -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <button id="btn-standard-251" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg flex-1 transition-all">
                        Oír Acorde Estándar
                    </button>
                    <button id="btn-harris-251" class="bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 px-4 rounded-lg flex-1 transition-all">
                        Oír Sustitución de Harris
                    </button>

                    <!-- Controles de Inversión -->
                    <div id="inversion-controls-251" class="hidden w-full md:col-span-2 p-3 bg-gray-700 rounded-lg -mt-4">
                        <p class="text-sm text-center text-gray-400 mb-2">Practicar Inversiones (solo acorde):</p>
                        <div class="flex justify-around gap-2">
                             <button id="btn-inv-1" class="inv-button">Fundamental</button>
                             <button id="btn-inv-2" class="inv-button">1ra Inversión</button>
                             <button id="btn-inv-3" class="inv-button">2da Inversión</button>
                             <button id="btn-inv-4" class="inv-button">3ra Inversión</button>
                        </div>
                    </div>
                </div>

                <!-- Visualizador de Piano -->
                <div class="bg-gray-700 p-4 rounded-lg">
                    <p class="text-sm text-gray-400 mb-4">Visualizador de Teclado (Rango: C2 - C6)</p>
                    <div class="piano-scroll-container">
                        <div id="piano-container-251" class="piano-container">
                            <!-- Las teclas del piano se generarán aquí con JS -->
                        </div>
                    </div>
                    <div id="note-display-251" class="note-display"></div>
                    <div class="flex justify-start gap-4 mt-2 text-sm">
                        <div class="flex items-center"><div class="w-4 h-4 rounded bg-cyan-600 mr-2"></div>Nota del Acorde</div>
                        <div class="flex items-center"><div class="w-4 h-4 rounded bg-orange-500 mr-2"></div>Nota del Bajo</div>
                    </div>
                </div>

            </div>

            <!-- Navegación -->
            <div class="flex justify-between items-center">
                <button id="btn-prev-251" class="nav-button bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-lg transition-all">
                    &larr; Anterior
                </button>
                <div id="step-indicator-251" class="text-gray-400"></div>
                <button id="btn-next-251" class="nav-button bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-lg transition-all">
                    Siguiente &rarr;
                </button>
            </div>
        </div>
        <!-- =========== FIN SECCIÓN 1 =========== -->


        <!-- =========== SECCIÓN 2: CONCEPTOS FUNDAMENTALES =========== -->
        <div id="page-diminished" class="tab-content bg-gray-800 p-6 rounded-b-lg rounded-tr-lg shadow-xl mb-6">
            <h2 class="text-xl text-center text-gray-400 mb-4">El Decodificador de Acordes Disminuidos</h2>

            <!-- Selector de Familia Disminuida -->
            <div class="mb-6 max-w-sm mx-auto">
                <label for="key-select-diminished" class="block text-sm font-medium text-gray-400 mb-2 text-center">Selecciona una Familia Disminuida (Base):</label>
                <select id="key-select-diminished" class="bg-gray-700 border border-gray-600 text-white text-lg rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block w-full p-2.5">
                    <option value="C" selected>Cdim7 (C, Eb, Gb, A)</option>
                    <option value="Db">C#dim7 (C#, E, G, Bb)</option>
                    <option value="D">Ddim7 (D, F, Ab, B)</option>
                </select>
            </div>

            <!-- Tarjeta Principal del Concepto -->
            <div class="bg-gray-800 rounded-lg mb-6">
                
                <!-- Explicación de las 3 Familias -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 text-center">
                    <div class="bg-gray-700 p-3 rounded-lg">
                        <h4 class="text-sm font-semibold text-gray-400">Familia "Arriba" (iiø)</h4>
                        <button id="btn-dim-up" class="w-full text-lg font-bold text-cyan-300 py-2 px-3 rounded-lg hover:bg-gray-600 transition-all"></button>
                    </div>
                    <div class="bg-gray-900 border-2 border-cyan-500 p-3 rounded-lg">
                        <h4 class="text-sm font-semibold text-cyan-300">Familia "Base" (dim7)</h4>
                        <button id="btn-dim-base" class="w-full text-lg font-bold text-white py-2 px-3 rounded-lg hover:bg-gray-600 transition-all"></button>
                    </div>
                    <div class="bg-gray-700 p-3 rounded-lg">
                        <h4 class="text-sm font-semibold text-gray-400">Familia "Abajo" (V7)</h4>
                        <button id="btn-dim-down" class="w-full text-lg font-bold text-cyan-300 py-2 px-3 rounded-lg hover:bg-gray-600 transition-all"></button>
                    </div>
                </div>
                
                <p class="text-gray-300 mb-6 text-center">
                    Toma la familia "Base" y "toma prestada" una nota de las familias vecinas (arriba o abajo) para generar nuevos acordes.
                </p>

                <!-- Botones de Acordes Generados (Granular) -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-gray-700 p-4 rounded-lg">
                        <h4 class="text-lg font-semibold text-white mb-3 text-center">Generar Familia V7 (Bajar una nota)</h4>
                        <p class="text-sm text-gray-400 text-center mb-3">Toma una nota de la "Base" y bájala 1/2 tono a una nota de la familia "Abajo".</p>
                        <div id="dominant-buttons-container" class="space-y-2">
                            <!-- Los botones se generan aquí con JS -->
                        </div>
                    </div>
                    
                    <div class="bg-gray-700 p-4 rounded-lg">
                        <h4 class="text-lg font-semibold text-white mb-3 text-center">Generar Familia m7b5 (Subir una nota)</h4>
                        <p class="text-sm text-gray-400 text-center mb-3">Toma una nota de la "Base" y súbela 1/2 tono a una nota de la familia "Arriba".</p>
                        <div id="m7b5-buttons-container" class="space-y-2">
                            <!-- Los botones se generan aquí con JS -->
                        </div>
                    </div>
                </div>

                <!-- SECCIÓN: ESCALAS 6 DIMINISHED -->
                <div class="bg-gray-700 p-4 rounded-lg mt-6">
                    <h4 class="text-lg font-semibold text-white mb-3 text-center">Las Escalas de 8 Notas (6 Diminished)</h4>
                    <p class="text-sm text-gray-400 text-center mb-4">El corazón del sistema: un acorde de 6ª (Mayor o Menor) combinado con un acorde disminuido.</p>
                    <div class="mb-4 max-w-xs mx-auto">
                        <label for="key-select-scales" class="block text-sm font-medium text-gray-400 mb-2 text-center">Selecciona una Tónica:</label>
                        <select id="key-select-scales" class="bg-gray-600 border border-gray-500 text-white text-lg rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block w-full p-2.5">
                            <option value="C" selected>C</option>
                            <option value="Db">Db / C#</option>
                            <option value="D">D</option>
                            <option value="Eb">Eb</option>
                            <option value="E">E</option>
                            <option value="F">F</option>
                            <option value="Gb">Gb / F#</option>
                            <option value="G">G</option>
                            <option value="Ab">Ab</option>
                            <option value="A">A</option>
                            <option value="Bb">Bb</option>
                            <option value="B">B / Cb</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <button id="btn-maj6-dim-scale" class="bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 px-4 rounded-lg flex-1 transition-all">
                            Oír Escala Major 6 Diminished
                        </button>
                        <button id="btn-min6-dim-scale" class="bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 px-4 rounded-lg flex-1 transition-all">
                            Oír Escala minor 6 Diminished
                        </button>
                    </div>
                </div>

                <!-- Visualizador de Piano -->
                <div class="bg-gray-700 p-4 rounded-lg mt-6">
                    <p class="text-sm text-gray-400 mb-4">Visualizador de Teclado (Rango: C2 - C6)</p>
                    <div class="piano-scroll-container">
                        <div id="piano-container-diminished" class="piano-container">
                            <!-- Las teclas del piano se generarán aquí con JS -->
                        </div>
                    </div>
                    <div id="note-display-diminished" class="note-display"></div>
                    <div class="flex justify-start gap-4 mt-2 text-sm">
                        <div class="flex items-center"><div class="w-4 h-4 rounded bg-cyan-600 mr-2"></div>Nota del Acorde</div>
                        <div class="flex items-center"><div class="w-4 h-4 rounded bg-orange-500 mr-2"></div>Nota del Bajo</div>
                    </div>
                </div>

            </div>
        </div>
        <!-- =========== FIN SECCIÓN 2 =========== -->

        <!-- =========== NUEVA SECCIÓN 3: IMPROVISACIÓN =========== -->
        <div id="page-improvisation" class="tab-content bg-gray-800 p-6 rounded-b-lg rounded-tr-lg shadow-xl mb-6">
            <h2 class="text-xl text-center text-gray-400 mb-6">Conceptos de Improvisación Bebop (Sistema Harris)</h2>

            <!-- ===== SUBSECCIÓN INTERACTIVA: NOTAS EXTRAS ===== -->
            <div class="interactive-section mb-8">
                <h3 class="mb-4">Explorador Interactivo de "Notas Extras"</h3>
                <p class="text-sm text-gray-400 mb-6">Practica cómo añadir notas cromáticas a las escalas para que las notas del acorde caigan en tiempo fuerte (Reglas Bebop).</p>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div>
                        <label for="impro-scale-type" class="block text-sm font-medium text-gray-400 mb-1">Tipo de Escala:</label>
                        <select id="impro-scale-type" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block w-full p-2.5">
                            <option value="dominant" selected>Dominante 7</option>
                            <option value="major6dim">Major 6 Diminished</option>
                            <option value="minor6dim">minor 6 Diminished</option>
                        </select>
                    </div>
                    <div>
                        <label for="impro-scale-root" class="block text-sm font-medium text-gray-400 mb-1">Tónica:</label>
                        <select id="impro-scale-root" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block w-full p-2.5">
                            <option value="C" selected>C</option>
                            <option value="Db">Db / C#</option>
                            <option value="D">D</option>
                            <option value="Eb">Eb</option>
                            <option value="E">E</option>
                            <option value="F">F</option>
                            <option value="Gb">Gb / F#</option>
                            <option value="G">G</option>
                            <option value="Ab">Ab</option>
                            <option value="A">A</option>
                            <option value="Bb">Bb</option>
                            <option value="B">B / Cb</option>
                        </select>
                    </div>
                    <div>
                        <label for="impro-start-degree" class="block text-sm font-medium text-gray-400 mb-1">Nota de Inicio (Grado):</label>
                        <select id="impro-start-degree" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block w-full p-2.5">
                            <option value="8">8 (Octava)</option>
                            <option value="7">7</option>
                            <option value="6">6</option>
                            <option value="5">5</option>
                            <option value="4">4</option>
                            <option value="3">3</option>
                            <option value="2">2</option>
                            <option value="1">1 (Tónica)</option> 
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                     <button id="btn-apply-rule1" class="control-button bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-2 px-4 rounded-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                         Aplicar Regla 1 (0 ó 1 Nota Extra)
                     </button>
                     <button id="btn-apply-rule2" class="control-button bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-2 px-4 rounded-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                         Aplicar Regla 2 (2 ó 3 Notas Extras)
                     </button>
                </div>
                
                 <!-- Piano para Improvisación -->
                 <div class="bg-gray-700 p-4 rounded-lg">
                    <p class="text-sm text-gray-400 mb-4">Resultado (Rango: C2 - C6)</p>
                    <div class="piano-scroll-container">
                        <div id="piano-container-impro" class="piano-container">
                            <!-- Piano para la sección de improvisación -->
                        </div>
                    </div>
                    <div id="note-display-impro" class="note-display"></div>
                    <div class="flex justify-start gap-4 mt-2 text-sm">
                        <div class="flex items-center"><div class="w-4 h-4 rounded bg-cyan-600 mr-2"></div>Nota de Escala/Acorde</div>
                        <div class="flex items-center"><div class="w-4 h-4 rounded bg-amber-400 mr-2"></div>Nota Extra</div>
                    </div>
                </div>
            </div>
            <!-- ===== FIN SUBSECCIÓN INTERACTIVA ===== -->

            <p>Esta sección resume las ideas clave de Barry Harris para construir líneas melódicas en el estilo Bebop, basadas en sus conceptos armónicos. El orden sigue una progresión de dificultad conceptual.</p>

            <h3>1. Fundamentos: Las 3 Familias y sus Dominantes</h3>
            <p>Todo el sistema melódico, al igual que el armónico, se deriva de la relación entre los 3 únicos acordes disminuidos 7 y los acordes dominantes 7 que generan.</p>
            <ul>
                <li>Hay 3 acordes disminuidos 7: <code>Cdim7</code> (C-Eb-Gb-A), <code>C#dim7</code> (C#-E-G-Bb), <code>Ddim7</code> (D-F-Ab-B).</li>
                <li>Cada disminuido 7 genera 4 acordes Dominantes 7 al bajar una de sus notas medio tono (ej: de <code>C#dim7</code> salen <code>C7</code>, <code>Eb7</code>, <code>Gb7(F#7)</code>, <code>A7</code>).</li>
                <li>Estos 4 dominantes están **relacionados** y sus escalas se pueden usar intercambiablemente. Harris dice: "Juega con tus hermanos".</li>
            </ul>

            <h3>2. Las 4 Escalas de Barry Harris (8 Notas)</h3>
            <p>En lugar de los modos tradicionales, Harris usa 4 escalas principales de 8 notas, que combinan acordes de 6ª con disminuidos.</p>
            <ul>
                <li><strong>Major 6 Diminished:</strong> Acorde Maj6 + Acorde dim7 un semitono abajo (ej: <code>C6</code> + <code>Bdim7</code> = C-D-E-F-G-Ab-A-B). Útil para acordes Maj7 o Maj6. <strong>Nota:</strong> En PDFs a veces se indica el dim7 un tono arriba (Ddim7), pero Bdim7 es más consistente con la escala resultante y ejemplos.</li>
                <li><strong>minor 6 Diminished:</strong> Acorde min6 + Acorde dim7 un semitono abajo (ej: <code>Cm6</code> + <code>Bdim7</code> = C-D-Eb-F-G-Ab-A-B). Útil para acordes m7, m7b5 y dominantes alterados (si se toca desde la b2).</li>
                <li><strong>Dominant 7 Diminished:</strong> Acorde Dom7 + Acorde dim7 un semitono abajo (ej: <code>C7</code> + <code>Bdim7</code> = C-D-E-F-G-Ab-Bb-B). Es la escala disminuida Semitono-Tono (usada por muchos, no exclusiva de Harris).</li>
                <li><strong>Dominant 7b5 Diminished:</strong> Acorde Dom7b5 + Acorde dim7 un semitono abajo (ej: <code>C7b5</code> + <code>Bdim7</code> = C-D-E-F-Gb-Ab-Bb-B). También llamada escala de Tonos Enteros disminuida.</li>
            </ul>

            <h3>3. Reglas Rítmicas: Las "Notas Extras"</h3>
            <p>Para que las notas importantes del acorde caigan en los tiempos fuertes al tocar escalas en corcheas (especialmente descendiendo), Harris añade notas cromáticas de paso ("notas extras"). Esto es crucial para el sonido Bebop.</p>
            <ul>
                <li><strong>Regla Principal:</strong> Las notas del acorde deben caer en los tiempos fuertes (1, 2, 3, 4).</li>
                <li><strong>Aplicación (Dominante):</strong>
                    <ul>
                        <li>Si empiezas en nota del acorde (1=Tónica, 3, 5, b7): Añade <strong>1 o 3 notas extras</strong> (ej: C->B->Bb...). La Tónica (1 u 8) sigue regla especial: siempre 1 nota extra (la 7 Mayor).</li>
                        <li>Si empiezas en nota de la escala (2, 4, 6): Añade <strong>0 o 2 notas extras</strong> (ej: D->Db->C->B->Bb...).</li>
                    </ul>
                </li>
                <li><strong>Aplicación (Mayor/Menor - Escalas 6 Dim):</strong>
                     <ul>
                         <li>Si empiezas en nota del acorde de 6ª (1, 3, 5, 6): Añade <strong>1 o 3 notas extras</strong> (Harris usa cromatismos específicos).</li>
                         <li>Si empiezas en nota del disminuido (b2, b3, #4, b6 en Maj6 / 2, 4, #5, 7 en min6): Añade <strong>0 o 2 notas extras</strong>.</li>
                         <li><strong>Simplificación Común:</strong> A menudo se usa la regla de 1 nota extra (cromática) entre 6 y 5 para Maj/min.</li>
                     </ul>
                </li>
                <li><strong>Expansión:</strong> Se pueden añadir muchas más notas extras cromáticamente, siempre siguiendo la lógica "par con par" o "impar con impar".</li>
            </ul>

             <h4>Misceláneas de las Reglas</h4>
             <p>Hay reglas adicionales para aplicar las notas extras en situaciones comunes:</p>
             <ul>
                <li><strong>Ascenso y Descenso:</strong> Al subir y luego bajar, la regla se aplica desde la nota más alta alcanzada.</li>
                <li><strong>Comienzo con Tresillo:</strong> La regla se aplica según la nota central del tresillo.</li>
                <li><strong>Comienzo con Arpegio (Tríada):</strong> La regla se aplica según la nota superior de la tríada.</li>
                <li><strong>Comienzo con Arpegio (Cuatríada):</strong> La regla se aplica según la nota inferior del arpegio (con excepciones).</li>
                <li><strong>Comienzo con Semitono + Tresillo:</strong> La regla se aplica según la nota superior del arpegio en el tresillo.</li>
             </ul>


            <h3>4. Aplicaciones Melódicas</h3>
            
            <h4>4.1. Uso de Escalas Dominantes Relacionadas</h4>
            <p>Ya que los 4 dominantes de una familia son "hermanos", puedes empezar una frase con la escala de <code>C7</code> y continuarla fluidamente con notas de la escala de <code>Eb7</code>, <code>F#7</code> o <code>A7</code> antes de resolver. Esto crea líneas con tensión "outside" pero lógicas dentro del sistema.</p>

            <h4>4.2. "Contornos" (Outlining)</h4>
            <p>En lugar de pensar modo por modo (D Dórico, G Mixolidio, C Jónico), Harris piensa en **una escala principal que "contornea" o define la progresión**. El sistema se simplifica a movimientos V-I.</p>
            <ul>
                <li><strong>Ejemplo II-V-I (Dm7-G7-C):</strong> Se usa principalmente la escala de <strong>G7</strong> sobre ambos acordes (Dm7 y G7).</li>
                <li><strong>Blues / Rhythm Changes:** Se definen "esquemas de escalas" para toda la forma, indicando qué escala dominante o mayor/menor usar sobre secciones de varios compases (ej: C7 up, F7 up, C7 up & down...).</li>
            </ul>

            <h4>4.3. El "Importante Menor"</h4>
            <p>Es el acorde menor (usualmente m7 o m9) construido sobre la <strong>5ª justa</strong> de un acorde dominante.</p>
            <ul>
                <li><strong>Ejemplo:</strong> Sobre <code>G7</code>, el "importante menor" es <code>Dm7</code> o <code>Dm9</code>.</li>
                <li><strong>Uso:</strong> Se usa mucho melódicamente, arpegiando el "importante menor" para crear un sonido <code>V7(b9, b5)</code> o simplemente como color sobre el V7. Muy común en turnarounds y secuencias II-V-I-VI.</li>
            </ul>

            <h4>4.4. "Merodeando Notas" (Surrounding / Enclosures)</h4>
            <p>Similar al concepto clásico de apoyaturas o notas vecinas, pero extendido. Una nota objetivo (usualmente del acorde) se "merodea" o rodea con notas de la escala, **incluyendo notas de las escalas dominantes relacionadas**.</p>
            <ul>
                <li><strong>Ejemplo:</strong> Para llegar a la nota <code>E</code> (3ª de C7), puedes tocar <code>F# -> D# -> E</code> (usando notas de la escala de A7, relacionada con C7).</li>
                <li>Esto crea un sonido muy cromático y característico del Bebop.</li>
            </ul>

            <h4>4.5. "Frases para Salir de Problemas" (Pivot Phrases)</h4>
            <p>Son 4 frases melódicas cortas (licks) que empiezan en la 5ª, 4ª, 3ª y 2ª de la escala dominante. Sirven como "comodines" para conectar ideas, cambiar de dirección o simplemente llenar espacio de forma estilística.</p>
            <ul>
                <li>Se pueden encadenar entre sí o con fragmentos de escalas.</li>
            </ul>

            <h4>4.6. Tritono Melódico</h4>
            <p>Se practica tocar frases, arpegios o escalas y transportarlas instantáneamente un tritono (ej. una frase sobre G7, repetirla sobre Db7) para usar sobre sustituciones tritonales o simplemente como tensión.</p>


            <p class="mt-8 text-sm text-gray-500">Nota: Esta es una síntesis basada en los documentos proporcionados. El sistema de Barry Harris es profundo y se explora mejor con la práctica y la escucha.</p>

        </div>
        <!-- =========== FIN SECCIÓN 3 =========== -->

    </div>

    <script>
        // --- Mover definición de drawPiano fuera de DOMContentLoaded ---
        const notePositions = {
                'C2': { white: 0 }, 'Db2': { black: 25 }, 'D2': { white: 40 }, 'Eb2': { black: 65 }, 'E2': { white: 80 },
                'F2': { white: 120 }, 'Gb2': { black: 145 }, 'G2': { white: 160 }, 'Ab2': { black: 185 }, 'A2': { white: 200 }, 'Bb2': { black: 225 }, 'B2': { white: 240 },
                'C3': { white: 280 }, 'Db3': { black: 305 }, 'D3': { white: 320 }, 'Eb3': { black: 345 }, 'E3': { white: 360 },
                'F3': { white: 400 }, 'Gb3': { black: 425 }, 'G3': { white: 440 }, 'Ab3': { black: 465 }, 'A3': { white: 480 }, 'Bb3': { black: 505 }, 'B3': { white: 520 },
                'C4': { white: 560 }, 'Db4': { black: 585 }, 'D4': { white: 600 }, 'Eb4': { black: 625 }, 'E4': { white: 640 },
                'F4': { white: 680 }, 'Gb4': { black: 705 }, 'G4': { white: 720 }, 'Ab4': { black: 745 }, 'A4': { white: 760 }, 'Bb4': { black: 785 }, 'B4': { white: 800 },
                'C5': { white: 840 }, 'Db5': { black: 865 }, 'D5': { white: 880 }, 'Eb5': { black: 905 }, 'E5': { white: 920 },
                'F5': { white: 960 }, 'Gb5': { black: 985 }, 'G5': { white: 1000 }, 'Ab5': { black: 1025 }, 'A5': { white: 1040 }, 'Bb5': { black: 1065 }, 'B5': { white: 1080 },
                'C6': { white: 1120 }
            };
        const whiteNotesOrder = [
                'C2', 'D2', 'E2', 'F2', 'G2', 'A2', 'B2',
                'C3', 'D3', 'E3', 'F3', 'G3', 'A3', 'B3',
                'C4', 'D4', 'E4', 'F4', 'G4', 'A4', 'B4',
                'C5', 'D5', 'E5', 'F5', 'G5', 'A5', 'B5',
                'C6'
            ];
        const blackNotesOrder = [
                'Db2', 'Eb2', 'Gb2', 'Ab2', 'Bb2',
                'Db3', 'Eb3', 'Gb3', 'Ab3', 'Bb3',
                'Db4', 'Eb4', 'Gb4', 'Ab4', 'Bb4',
                'Db5', 'Eb5', 'Gb5', 'Ab5', 'Bb5'
            ];
        
        function getNoteName(note) {
            if (!note) return "";
            return note.slice(0, -1).replace(/[0-9]/, '');
        }

        function drawPiano(container) {
            container.innerHTML = ''; 

            whiteNotesOrder.forEach(note => {
                const keyEl = document.createElement('div');
                keyEl.className = `piano-key white-key`;
                keyEl.dataset.note = note;
                keyEl.style.left = `${notePositions[note].white}px`;
                
                const label = document.createElement('span');
                label.className = 'note-label';
                label.textContent = getNoteName(note);
                keyEl.appendChild(label);

                container.appendChild(keyEl);
            });

            blackNotesOrder.forEach(note => {
                const keyEl = document.createElement('div');
                keyEl.className = `piano-key black-key`;
                keyEl.dataset.note = note;
                keyEl.style.left = `${notePositions[note].black}px`;
                container.appendChild(keyEl);
            });

            const lastWhiteKeyOffset = notePositions['C6'].white;
            container.style.width = `${lastWhiteKeyOffset + 40 + 10}px`; 
        }
        // --- Fin de definición de drawPiano movida ---

        document.addEventListener('DOMContentLoaded', () => {
            
            // --- UTILIDADES GLOBALES DE TEORÍA Y AUDIO ---
            let audioCtx = null;
            const oscillatorType = 'triangle'; 
            
            const noteFrequencies = {
                'C2': 65.41, 'Db2': 69.30, 'D2': 73.42, 'Eb2': 77.78, 'E2': 82.41, 'F2': 87.31, 'Gb2': 92.50, 'G2': 98.00, 'Ab2': 103.83, 'A2': 110.00, 'Bb2': 116.54, 'B2': 123.47,
                'C3': 130.81, 'Db3': 138.59, 'D3': 146.83, 'Eb3': 155.56, 'E3': 164.81, 'F3': 174.61, 'Gb3': 185.00, 'G3': 196.00, 'Ab3': 207.65, 'A3': 220.00, 'Bb3': 233.08, 'B3': 246.94,
                'C4': 261.63, 'Db4': 277.18, 'D4': 293.66, 'Eb4': 311.13, 'E4': 329.63, 'F4': 349.23, 'Gb4': 369.99, 'G4': 392.00, 'Ab4': 415.30, 'A4': 440.00, 'Bb4': 466.16, 'B4': 493.88,
                'C5': 523.25, 'Db5': 554.37, 'D5': 587.33, 'Eb5': 622.25, 'E5': 659.25, 'F5': 698.46, 'Gb5': 739.99, 'G5': 783.99, 'Ab5': 830.61, 'A5': 880.00, 'Bb5': 932.33, 'B5': 987.77,
                'C6': 1046.50
            };
            const ALL_NOTES = Object.keys(noteFrequencies);
            
            // Usamos C2 como referencia para cálculos de octava iniciales
            const KEY_ROOT_NOTES = { 
                'C': 'C2', 'Db': 'Db2', 'D': 'D2', 'Eb': 'Eb2', 'E': 'E2', 'F': 'F2',
                'Gb': 'Gb2', 'G': 'G2', 'Ab': 'Ab2', 'A': 'A2', 'Bb': 'Bb2', 'B': 'B2'
            };

            // Usamos C3 como referencia para cálculos de escalas
            const SCALE_KEY_ROOT_NOTES = { 
                'C': 'C3', 'Db': 'Db3', 'D': 'D3', 'Eb': 'Eb3', 'E': 'E3', 'F': 'F3',
                'Gb': 'Gb3', 'G': 'G3', 'Ab': 'Ab3', 'A': 'A3', 'Bb': 'Bb3', 'B': 'B3'
            };
            
            // --- Declaraciones de Elementos del DOM ---
            // Globales
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            
            // Sección 1 (2-5-1)
            const pianoContainer251 = document.getElementById('piano-container-251');
            const noteDisplay251 = document.getElementById('note-display-251'); 
            const conceptTitleEl251 = document.getElementById('concept-title-251');
            const conceptSubtitleEl251 = document.getElementById('concept-subtitle-251');
            const conceptDescriptionEl251 = document.getElementById('concept-description-251');
            const btnStandard251 = document.getElementById('btn-standard-251');
            const btnHarris251 = document.getElementById('btn-harris-251');
            const btnPrev251 = document.getElementById('btn-prev-251');
            const btnNext251 = document.getElementById('btn-next-251');
            const stepIndicator251 = document.getElementById('step-indicator-251');
            const keySelect251 = document.getElementById('key-select-251');
            const inversionControls251 = document.getElementById('inversion-controls-251');
            const btnInv1 = document.getElementById('btn-inv-1');
            const btnInv2 = document.getElementById('btn-inv-2');
            const btnInv3 = document.getElementById('btn-inv-3');
            const btnInv4 = document.getElementById('btn-inv-4');

            // Sección 2 (Diminished)
            const pianoContainerDiminished = document.getElementById('piano-container-diminished');
            const noteDisplayDiminished = document.getElementById('note-display-diminished'); 
            const keySelectDiminished = document.getElementById('key-select-diminished');
            const domButtonsContainer = document.getElementById('dominant-buttons-container');
            const m7b5ButtonsContainer = document.getElementById('m7b5-buttons-container');
            const btnDimUp = document.getElementById('btn-dim-up');
            const btnDimBase = document.getElementById('btn-dim-base');
            const btnDimDown = document.getElementById('btn-dim-down');
            const keySelectScales = document.getElementById('key-select-scales');
            const btnMaj6DimScale = document.getElementById('btn-maj6-dim-scale');
            const btnMin6DimScale = document.getElementById('btn-min6-dim-scale');
            
            // Sección 3 (Improvisación - Notas Extras)
            const pianoContainerImpro = document.getElementById('piano-container-impro');
            const noteDisplayImpro = document.getElementById('note-display-impro');
            const improScaleTypeSelect = document.getElementById('impro-scale-type');
            const improScaleRootSelect = document.getElementById('impro-scale-root');
            const improStartDegreeSelect = document.getElementById('impro-start-degree');
            const btnApplyRule1 = document.getElementById('btn-apply-rule1');
            const btnApplyRule2 = document.getElementById('btn-apply-rule2');

            // --- Funciones de Utilidad ---
            // getNoteName está definida globalmente ahora
            
            function transpose(note, semitones) {
                const index = ALL_NOTES.indexOf(note);
                if (index === -1) {
                    console.error("Nota no encontrada en el mapa:", note);
                    return note;
                }
                const newIndex = index + semitones;
                if (newIndex >= 0 && newIndex < ALL_NOTES.length) {
                    return ALL_NOTES[newIndex];
                } else {
                    // Intenta wrappear si está fuera de rango C2-C6
                    const normalizedIndex = index % 12;
                    let targetNoteIndex = (normalizedIndex + semitones) % 12;
                    if (targetNoteIndex < 0) {
                        targetNoteIndex += 12;
                    }
                    // Intenta mantener una octava razonable (ej. 3 o 4)
                    let targetOctave = Math.floor(index / 12) + Math.floor((index % 12 + semitones) / 12);
                    targetOctave = Math.max(2, Math.min(5, targetOctave)); // Limitar octavas 2-5
                    
                    // Encuentra la nota base (C, Db, etc.)
                     let noteBaseName = '';
                     for(let i=0; i<ALL_NOTES.length; i++){
                         if(i % 12 === targetNoteIndex){
                             noteBaseName = getNoteName(ALL_NOTES[i]);
                             break;
                         }
                     }
                     if(!noteBaseName){
                         console.error("No se pudo encontrar el nombre base para el índice:", targetNoteIndex);
                         return note; // Fallback
                     }

                    const newNote = `${noteBaseName}${targetOctave}`;

                    if(noteFrequencies[newNote]) return newNote;
                    
                    // Fallback si la octava calculada no existe
                    console.warn(`Transposición compleja fuera de rango o nota inexistente: ${note} + ${semitones} -> ${newNote}. Intentando octava 4.`);
                     const fallbackNote = `${noteBaseName}4`;
                     if(noteFrequencies[fallbackNote]) return fallbackNote;
                    
                    return note; // Último fallback
                }
            }
            
            function getChordInversions(notes) {
                if (!notes || notes.length !== 4) {
                    console.warn("Se necesitan 4 notas para getChordInversions", notes);
                    return [notes, notes, notes, notes]; // Safety check
                }
                const inversions = [];
                // Asegura que las transposiciones no bajen de C2 ni suban mucho
                 const t = (n, s) => {
                     let newNote = transpose(n, s);
                     // Si el resultado es menor que C2, sube una octava
                     if (ALL_NOTES.indexOf(newNote) < ALL_NOTES.indexOf('C2')) {
                         newNote = transpose(newNote, 12);
                     }
                      // Si el resultado es mayor que B5 (antes de C6), baja una octava
                      if (ALL_NOTES.indexOf(newNote) > ALL_NOTES.indexOf('B5')) {
                          newNote = transpose(newNote, -12);
                      }
                     return newNote;
                 };

                inversions.push(notes); // Inv 1 (Posición Fundamental del acorde de 6ª)
                inversions.push([notes[1], notes[2], notes[3], t(notes[0], 12)]); // Inv 2
                inversions.push([notes[2], notes[3], t(notes[0], 12), t(notes[1], 12)]); // Inv 3
                inversions.push([notes[3], t(notes[0], 12), t(notes[1], 12), t(notes[2], 12)]); // Inv 4
                return inversions;
            }

            function getFrequency(note) {
                return noteFrequencies[note] || 0;
            }

            function playChord(notes, duration = 1.5, startTime = 0) {
                if (!audioCtx) {
                    try {
                        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    } catch (e) {
                         console.error("Web Audio API no soportada", e);
                         return; // Salir si no hay AudioContext
                    }
                }
                 if (audioCtx.state === 'suspended') {
                     audioCtx.resume();
                 }

                const scheduledTime = audioCtx.currentTime + startTime;
                const gain = Math.min(0.5, 0.8 / notes.length) ; 

                notes.forEach(note => {
                    const freq = getFrequency(note);
                    if (freq === 0) {
                        console.warn("Frecuencia 0 para nota:", note);
                        return; 
                    }

                    const oscillator = audioCtx.createOscillator();
                    const gainNode = audioCtx.createGain();

                    oscillator.type = oscillatorType;
                    oscillator.frequency.setValueAtTime(freq, scheduledTime);
                    
                    gainNode.gain.setValueAtTime(gain, scheduledTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.0001, scheduledTime + duration);

                    oscillator.connect(gainNode);
                    gainNode.connect(audioCtx.destination);

                    oscillator.start(scheduledTime);
                    oscillator.stop(scheduledTime + duration);
                });
            }

            let scalePlaybackTimeout = null; 

            // Función para tocar escalas animadas (acordes, 6dim, notas extras)
            // Recibe notas con info de si son 'extra'
            function playAnimatedScale(notesWithInfo, container) {
                if (!audioCtx) {
                     try {
                        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    } catch (e) {
                         console.error("Web Audio API no soportada", e);
                         return;
                    }
                }
                 if (audioCtx.state === 'suspended') {
                     audioCtx.resume();
                 }

                if (scalePlaybackTimeout) {
                    clearTimeout(scalePlaybackTimeout);
                    scalePlaybackTimeout = null;
                }
                highlightKeys(container, []); 

                const duration = 0.25; 
                
                notesWithInfo.forEach(({note, isExtra}, index) => {
                    const startTime = index * duration;
                    
                    scalePlaybackTimeout = setTimeout(() => {
                        highlightAnimatedKey(container, note, isExtra); // Resalta solo la nota actual con su tipo
                    }, startTime * 1000); 
                    
                    playChord([note], duration, startTime);
                });
                
                // Al final, no resaltar todo, dejar la última nota resaltada
                const endTime = notesWithInfo.length * duration;
                scalePlaybackTimeout = setTimeout(() => {
                    // Opcional: resaltar el acorde base al final?
                    // highlightKeys(container, notesWithInfo.filter(n => !n.isExtra).map(n => n.note));
                    scalePlaybackTimeout = null; 
                }, endTime * 1000);
            }

            // --- Nuevas funciones para Improvisación (Notas Extras) ---
            
            // Define las escalas base (intervalos desde la tónica en semitonos)
            const scaleFormulas = {
                dominant: [0, 2, 4, 5, 7, 9, 10], // Mixolidia (7 notas)
                major6dim: [0, 2, 4, 5, 7, 8, 9, 11], // C D E F G Ab A B (8 notas)
                minor6dim: [0, 2, 3, 5, 7, 8, 9, 11]  // C D Eb F G Ab A B (8 notas) - Ajustada, PDF es ambiguo
            };
            
            // Define los grados que son "notas del acorde" para cada tipo
            // Para Dominante: 1, 3, 5, b7
            // Para Maj6Dim: 1, 3, 5, 6 (notas del Maj6)
            // Para min6Dim: 1, b3, 5, 6 (notas del min6)
            const chordTonesMap = {
                 dominant: [1, 3, 5, 7], // Usando índice 1-based para grados
                 major6dim: [1, 3, 5, 6], // Grados del C6
                 minor6dim: [1, 3, 5, 6] // Grados del Cm6 (1, b3, 5, 6)
            };

            // Función principal para generar la escala descendente con notas extras
            function getBebopScale(scaleType, rootNote, startDegree) {
                const formula = scaleFormulas[scaleType];
                const scaleLength = formula.length; // 7 u 8
                const rootNoteIndex = ALL_NOTES.indexOf(rootNote);

                if (rootNoteIndex === -1) {
                    console.error("Nota raíz no encontrada:", rootNote);
                    return { rule1Scale: [], rule2Scale: [], rule1Label: 'Error', rule2Label: 'Error', canApplyRule1: false, canApplyRule2: false };
                }

                // Generar la escala base descendente desde startDegree hasta la tónica una octava abajo
                const baseScale = [];
                // Ajustar startDegree si es > scaleLength (ej: 8 para escala de 7 notas)
                 let currentDegree = parseInt(startDegree);
                 if (currentDegree > scaleLength && scaleLength === 7) currentDegree = 1; // Si es 8 en dom7, empieza en 1
                 if (currentDegree === 8 && scaleLength === 8) currentDegree = 1; // Si es 8 en 6dim, empieza en 1
                 // Ajuste para grado 1 -> tratarlo como 8 para descenso
                 if (currentDegree === 1) currentDegree = scaleLength + 1; // Tratar Tónica inicio como 8 (ó 9 si escala es 8)

                
                let startInterval = formula[(currentDegree - 1 -1 + scaleLength) % scaleLength]; // Intervalo de la nota de inicio real
                 // Asegurar que la nota de inicio esté en una octava razonable (4 o 5)
                 let startNote = transpose(rootNote, startInterval); // Calcula la nota de inicio desde la tónica base
                 // Ajuste de octava inicial
                 if(ALL_NOTES.indexOf(startNote) < ALL_NOTES.indexOf('C4')){
                     startNote = transpose(startNote, 12);
                 }
                 if(ALL_NOTES.indexOf(startNote) > ALL_NOTES.indexOf('B5')){
                      startNote = transpose(startNote, -12);
                  }
                 // Corrección si startDegree es 8 (Tónica superior)
                 if(parseInt(startDegree) === 8 || parseInt(startDegree) === 1){
                     startNote = transpose(rootNote, 12); // Asegura que empiece en la octava superior
                 }


                // Genera la escala descendente básica (1 octava + tónica)
                baseScale.push(startNote); // Añadir la nota de inicio
                let lastNote = startNote;
                for (let i = 1; i < scaleLength + 1; i++) { // Bucle ajustado
                    const degreeIndex = (currentDegree - 1 - i + scaleLength) % scaleLength;
                    const interval = formula[degreeIndex];
                    let nextIntervalDown = formula[(currentDegree - 1 - (i+1) + scaleLength) % scaleLength] ?? formula[formula.length -1]; // Siguiente intervalo teórico
                    
                    // Calcular semitonos de descenso desde la nota anterior
                    let semitonesDown = (ALL_NOTES.indexOf(lastNote) - ALL_NOTES.indexOf(transpose(rootNote, interval))) % 12;
                     if (semitonesDown < 0) semitonesDown += 12;
                    
                     // Determinar el descenso real (1 o 2 semitonos)
                     let realSemitonesDown = 2; // Por defecto tono
                     if ([3, 7].includes(scaleLength === 7 ? (degreeIndex + 1) % 7 || 7 : 0) || // semitonos en mixo (3-4, 7-1) - indices 2, 6
                         [3, 7].includes(scaleLength === 8 ? (degreeIndex + 1) % 8 || 8 : 0)) { // semitonos en 6 dim? (E-F, B-C) - indices 2, 7
                          // Lógica más precisa para semitonos según escala
                          const currentNoteName = getNoteName(lastNote);
                          const nextNoteName = getNoteName(transpose(rootNote, interval));
                          if ((currentNoteName === 'E' && nextNoteName === 'F') || (currentNoteName === 'B' && nextNoteName === 'C') ||
                              (scaleType === 'minor6dim' && currentNoteName === 'Ab' && nextNoteName === 'G')) { // Semitono descendente
                                realSemitonesDown = 1;
                          } else if (scaleType.includes('6dim') && (currentNoteName === 'A' && nextNoteName === 'Ab') || (currentNoteName === 'G' && nextNoteName === 'Gb')) {
                                // Semitonos específicos de las 6 dim
                                realSemitonesDown = 1;
                          }
                     }
                    
                    let note = transpose(lastNote, -realSemitonesDown);

                    // Forzar a que sea la nota correcta de la escala si la transposición falla
                    let expectedNote = transpose(rootNote, interval);
                    if (getNoteName(note) !== getNoteName(expectedNote)) {
                        note = expectedNote;
                        // Ajustar octava si es necesario
                         if (ALL_NOTES.indexOf(note) >= ALL_NOTES.indexOf(lastNote)) {
                             note = transpose(note, -12);
                         }
                    }

                    // Asegurar que no baje demasiado
                      if(ALL_NOTES.indexOf(note) < ALL_NOTES.indexOf('C2')){
                          break; // Detener si baja mucho
                      }
                    
                    baseScale.push(note);
                    lastNote = note;
                }

                // ---- Lógica de Reglas ----
                // Determinar grado real (1-8)
                let actualStartDegree = parseInt(startDegree);
                if (actualStartDegree === 1) actualStartDegree = 8; // Tratar Tónica como 8

                const isEvenStart = actualStartDegree % 2 === 0;
                const chordTonesDegrees = chordTonesMap[scaleType] || [];
                // Ajustar grados de acorde para Dominante (b7 es el grado 7)
                const isChordToneStart = chordTonesDegrees.includes(actualStartDegree);


                // Determinar qué reglas aplicar
                let rule1ExtraNotes = 0;
                let rule2ExtraNotes = 0;
                let rule1Insertions = []; // [{afterNoteIndex: noteIndex, extraNote: note}, ...]
                let rule2Insertions = [];

                if (scaleType === 'dominant') {
                    if (actualStartDegree === 8) { // Regla especial Tónica (8)
                        rule1ExtraNotes = 1;
                        rule1Insertions = [{ afterNoteIndex: 0, extraNote: transpose(baseScale[0], -1) }]; // 7 Mayor
                        rule2ExtraNotes = 1; // No aplica 3 notas
                        rule2Insertions = rule1Insertions;
                    } else if (isChordToneStart) { // Grados 3, 5, 7
                        rule1ExtraNotes = 1;
                        // Cromatismo entre 1 y b7. Indice de 1 es (actualStartDegree - 1)
                        rule1Insertions = [{ afterNoteIndex: actualStartDegree - 1, extraNote: transpose(baseScale[actualStartDegree - 1], -1) }];
                        rule2ExtraNotes = 3;
                        rule2Insertions = [
                            { afterNoteIndex: actualStartDegree - 3, extraNote: transpose(baseScale[actualStartDegree - 3], -1) }, // Entre 3 y 2
                            { afterNoteIndex: actualStartDegree - 2, extraNote: transpose(baseScale[actualStartDegree - 2], -1) }, // Entre 2 y 1
                            { afterNoteIndex: actualStartDegree - 1, extraNote: transpose(baseScale[actualStartDegree - 1], -1) }  // Entre 1 y b7
                        ];
                    } else { // Grados 2, 4, 6
                        rule1ExtraNotes = 0;
                        rule2ExtraNotes = 2;
                        rule2Insertions = [
                             { afterNoteIndex: actualStartDegree - 2, extraNote: transpose(baseScale[actualStartDegree - 2], -1) }, // Entre 2 y 1
                             { afterNoteIndex: actualStartDegree - 1, extraNote: transpose(baseScale[actualStartDegree - 1], -1) }  // Entre 1 y b7
                        ];
                    }
                } else { // major6dim y minor6dim (Simplificado con 1 nota extra entre 6 y 5)
                     const degree6Interval = 9; // Sexta Mayor
                     const degree5Interval = 7; // Quinta Justa
                     const degree6NoteIndexInBase = baseScale.findIndex(note => (ALL_NOTES.indexOf(note) - rootNoteIndex) % 12 === degree6Interval);
                     
                     if (isChordToneStart) { // 1, 3, 5, 6
                         rule1ExtraNotes = 1; 
                         if (degree6NoteIndexInBase !== -1 && degree6NoteIndexInBase < baseScale.length -1) {
                            rule1Insertions = [{ afterNoteIndex: degree6NoteIndexInBase, extraNote: transpose(baseScale[degree6NoteIndexInBase], -1)}]; // b6 entre 6 y 5
                         }
                         rule2ExtraNotes = 3; // TODO: Implementar lógica de 3 notas para 6dim
                         rule2Insertions = rule1Insertions; // Placeholder
                     } else { // Notas del disminuido
                         rule1ExtraNotes = 0;
                         rule2ExtraNotes = 2; // TODO: Implementar lógica de 2 notas para 6dim
                     }
                }
                
                // Aplicar las reglas (insertar notas extras)
                const applyRules = (insertions) => {
                    const resultScale = [];
                    let insertionIndex = 0;
                    for (let i = 0; i < baseScale.length; i++) {
                        resultScale.push({ note: baseScale[i], isExtra: false });
                        // Comprobar si hay que insertar una nota extra DESPUÉS de esta nota
                        if (insertionIndex < insertions.length && insertions[insertionIndex].afterNoteIndex === i) {
                            resultScale.push({ note: insertions[insertionIndex].extraNote, isExtra: true });
                            insertionIndex++;
                        }
                    }
                    return resultScale;
                };

                return {
                    rule1Scale: applyRules(rule1Insertions),
                    rule2Scale: applyRules(rule2Insertions),
                    rule1Label: `${rule1ExtraNotes} Nota${rule1ExtraNotes !== 1 ? 's' : ''} Extra${rule1ExtraNotes > 0 ? '' : 's'}`,
                    rule2Label: `${rule2ExtraNotes} Nota${rule2ExtraNotes !== 1 ? 's' : ''} Extra${rule2ExtraNotes > 0 ? '' : 's'}`,
                    canApplyRule1: true, // Siempre se puede aplicar 0 o 1
                    canApplyRule2: (scaleType === 'dominant' && actualStartDegree !== 8) || (scaleType !== 'dominant' && rule2ExtraNotes > 0) // Regla 2/3 no aplica a Tónica(8) en Dom7
                };
            }

            function updateImproControls() {
                 const scaleType = improScaleTypeSelect.value;
                 const rootNoteName = improScaleRootSelect.value;
                 const startDegree = parseInt(improStartDegreeSelect.value);
                 const rootNote = SCALE_KEY_ROOT_NOTES[rootNoteName];

                 const { rule1Label, rule2Label, canApplyRule1, canApplyRule2 } = getBebopScale(scaleType, rootNote, startDegree);

                 btnApplyRule1.textContent = `Oír Regla 1 (${rule1Label})`;
                 btnApplyRule2.textContent = `Oír Regla 2 (${rule2Label})`;
                 
                 btnApplyRule1.disabled = !canApplyRule1;
                 btnApplyRule2.disabled = !canApplyRule2;

                 highlightKeys(pianoContainerImpro, []); // Limpiar piano al cambiar controles
                 noteDisplayImpro.textContent = '';
            }

            btnApplyRule1.addEventListener('click', () => {
                const scaleType = improScaleTypeSelect.value;
                const rootNoteName = improScaleRootSelect.value;
                const startDegree = parseInt(improStartDegreeSelect.value);
                const rootNote = SCALE_KEY_ROOT_NOTES[rootNoteName];
                
                const { rule1Scale } = getBebopScale(scaleType, rootNote, startDegree);
                playAnimatedScale(rule1Scale, pianoContainerImpro);
            });
            
            btnApplyRule2.addEventListener('click', () => {
                const scaleType = improScaleTypeSelect.value;
                const rootNoteName = improScaleRootSelect.value;
                const startDegree = parseInt(improStartDegreeSelect.value);
                const rootNote = SCALE_KEY_ROOT_NOTES[rootNoteName];
                
                const { rule2Scale } = getBebopScale(scaleType, rootNote, startDegree);
                playAnimatedScale(rule2Scale, pianoContainerImpro);
            });

            // Highlight animado específico para notas extras
            function highlightAnimatedKey(container, note, isExtra = false) {
                 if (!container) return;
                 container.querySelectorAll('.piano-key').forEach(key => {
                    key.classList.remove('highlighted', 'highlighted-extra'); // Limpia ambos tipos
                 });
                 const keyEl = container.querySelector(`.piano-key[data-note="${note}"]`);
                 if (keyEl) {
                    keyEl.classList.add(isExtra ? 'highlighted-extra' : 'highlighted');
                 }
                
                // Actualizar display de nota actual
                 let noteDisplay;
                 if (container.id === 'piano-container-impro') {
                     noteDisplay = noteDisplayImpro;
                 } // Añadir otros pianos si es necesario
                
                 if (noteDisplay) {
                     noteDisplay.textContent = `Nota: ${getNoteName(note)} ${isExtra ? '(Extra)' : ''}`;
                 }
            }


            improScaleTypeSelect.addEventListener('change', updateImproControls);
            improScaleRootSelect.addEventListener('change', updateImproControls);
            improStartDegreeSelect.addEventListener('change', updateImproControls);


            // --- LÓGICA DE PESTAÑAS (TABS) ---
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tabId = button.dataset.tab;

                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');

                    tabContents.forEach(content => {
                        if (content.id === tabId) {
                            content.classList.add('active');
                        } else {
                            content.classList.remove('active');
                        }
                    });
                    
                    // Limpiar pianos al cambiar de pestaña
                     highlightKeys(pianoContainer251);
                     highlightKeys(pianoContainerDiminished);
                     highlightKeys(pianoContainerImpro);
                     inversionControls251.classList.add('hidden'); // Ocultar controles de inversión
                     noteDisplay251.textContent = '';
                     noteDisplayDiminished.textContent = '';
                     noteDisplayImpro.textContent = '';
                     if (scalePlaybackTimeout) { // Detener animación de escala si estaba en curso
                        clearTimeout(scalePlaybackTimeout);
                        scalePlaybackTimeout = null;
                     }
                });
            });


            // --- LÓGICA SECCIÓN 1: EXPLORADOR 2-5-1 ---
            
            let concepts251 = [];
            let currentConceptIndex251 = 0;

            function generateConcepts251(keyTonicRoot) { // keyTonicRoot es C2, Db2, etc.
                 const keyTonic = transpose(keyTonicRoot, 12); // Pasa a octava 3 para cálculos (C3, Db3...)
                 
                 const ii_root_note = transpose(keyTonic, 2);   // D3 (para C)
                 const V_root_note = transpose(keyTonic, 7);    // G3 (para C)
                 const I_root_note = keyTonic;                // C3 (para C)
                 
                 // AJUSTE: Mover todas las notas de acorde base a octava 2/3
                 const adjustOctave = (note) => {
                     let noteIndex = ALL_NOTES.indexOf(note);
                     // Si la nota está en octava 4 o más, bajarla una octava
                     if (noteIndex >= ALL_NOTES.indexOf('C4')) {
                         return transpose(note, -12);
                     }
                      // Si la nota está por debajo de F2, subirla una octava
                      if (noteIndex < ALL_NOTES.indexOf('F2')) {
                          return transpose(note, 12);
                      }
                     return note;
                 };

                 const ii_bass = transpose(ii_root_note, -12); // D2
                 const V_bass = transpose(V_root_note, -12);   // G2
                 const I_bass = transpose(I_root_note, -12);   // C2

                 const iiName = getNoteName(ii_root_note); 
                 const VName = getNoteName(V_root_note);   
                 const IName = getNoteName(I_root_note);   
                 
                 const ii_b3_note = transpose(ii_root_note, 3); 
                 const ii_b3_Name = getNoteName(ii_b3_note);   
                 
                 const ii_b7_note = transpose(ii_root_note, 10); 
                 const ii_b7_Name = getNoteName(ii_b7_note);   

                 const V_5_note = transpose(V_root_note, 7);   
                 const V_5_Name = getNoteName(V_5_note);     
                 
                 const V_b7_note = transpose(V_root_note, 10); 
                 const V_b7_Name = getNoteName(V_b7_note);    

                 const V_b2_note = transpose(V_root_note, 1);  
                 const V_b2_Name = getNoteName(V_b2_note);    

                 const I_5_note = transpose(I_root_note, 7);   
                 const I_5_Name = getNoteName(I_5_note);     
                 
                 // Generar notas de acorde (en octava baja) y sus inversiones
                 // Acordes Estándar (octava baja)
                 const std_ii_notes = [adjustOctave(ii_root_note), adjustOctave(transpose(ii_root_note, 3)), adjustOctave(transpose(ii_root_note, 7)), adjustOctave(transpose(ii_root_note, 10))].sort((a,b) => ALL_NOTES.indexOf(a) - ALL_NOTES.indexOf(b));
                 const std_V_notes = [adjustOctave(V_root_note), adjustOctave(transpose(V_root_note, 4)), adjustOctave(transpose(V_root_note, 7)), adjustOctave(transpose(V_root_note, 10))].sort((a,b) => ALL_NOTES.indexOf(a) - ALL_NOTES.indexOf(b));
                 const std_I_notes = [adjustOctave(I_root_note), adjustOctave(transpose(I_root_note, 4)), adjustOctave(transpose(I_root_note, 7)), adjustOctave(transpose(I_root_note, 11))].sort((a,b) => ALL_NOTES.indexOf(a) - ALL_NOTES.indexOf(b));

                 // Acordes de Harris (octava baja)
                 const c1_notes = [adjustOctave(ii_b3_note), adjustOctave(transpose(ii_b3_note, 4)), adjustOctave(transpose(ii_b3_note, 7)), adjustOctave(transpose(ii_b3_note, 9))].sort((a,b) => ALL_NOTES.indexOf(a) - ALL_NOTES.indexOf(b));
                 const c2_notes = [adjustOctave(ii_b7_note), adjustOctave(transpose(ii_b7_note, 4)), adjustOctave(transpose(ii_b7_note, 7)), adjustOctave(transpose(ii_b7_note, 9))].sort((a,b) => ALL_NOTES.indexOf(a) - ALL_NOTES.indexOf(b));
                 const c3_notes = [adjustOctave(V_5_note), adjustOctave(transpose(V_5_note, 3)), adjustOctave(transpose(V_5_note, 7)), adjustOctave(transpose(V_5_note, 9))].sort((a,b) => ALL_NOTES.indexOf(a) - ALL_NOTES.indexOf(b));
                 const c4_notes = [adjustOctave(V_b7_note), adjustOctave(transpose(V_b7_note, 4)), adjustOctave(transpose(V_b7_note, 7)), adjustOctave(transpose(V_b7_note, 9))].sort((a,b) => ALL_NOTES.indexOf(a) - ALL_NOTES.indexOf(b));
                 const c5_notes = [adjustOctave(V_b7_note), adjustOctave(transpose(V_b7_note, 3)), adjustOctave(transpose(V_b7_note, 7)), adjustOctave(transpose(V_b7_note, 9))].sort((a,b) => ALL_NOTES.indexOf(a) - ALL_NOTES.indexOf(b));
                 const c6_notes = [adjustOctave(V_b2_note), adjustOctave(transpose(V_b2_note, 3)), adjustOctave(transpose(V_b2_note, 7)), adjustOctave(transpose(V_b2_note, 9))].sort((a,b) => ALL_NOTES.indexOf(a) - ALL_NOTES.indexOf(b));
                 const c7_notes = [adjustOctave(I_root_note), adjustOctave(transpose(I_root_note, 4)), adjustOctave(transpose(I_root_note, 7)), adjustOctave(transpose(I_root_note, 9))].sort((a,b) => ALL_NOTES.indexOf(a) - ALL_NOTES.indexOf(b));
                 const c8_notes = [adjustOctave(I_5_note), adjustOctave(transpose(I_5_note, 4)), adjustOctave(transpose(I_5_note, 7)), adjustOctave(transpose(I_5_note, 9))].sort((a,b) => ALL_NOTES.indexOf(a) - ALL_NOTES.indexOf(b));

                return [
                    {
                        title: `1. El Acorde II (${iiName}m7)`,
                        subtitle: `Sustitución: ${ii_b3_Name}6 (Sexta Mayor Relativa)`,
                        description: `En lugar de ${iiName}m7, usamos un ${ii_b3_Name}6. ¡Son las mismas notas! El sistema de Harris prefiere el acorde de 6ª. El bajo se mantiene en ${iiName}.`,
                        standardChord: { name: `${iiName}m7`, notes: std_ii_notes },
                        harrisChord: { name: `${ii_b3_Name}6 / ${iiName}`, notes: [ii_bass, ...c1_notes], chordNotes: c1_notes, bassNote: ii_bass, inversions: getChordInversions(c1_notes) }
                    },
                    {
                        title: `2. El Acorde II (${iiName}m7)`,
                        subtitle: `Sustitución: ${ii_b7_Name}6 (Desde el Menor Importante)`,
                        description: `Otra opción para el II (${iiName}m7) es usar un ${ii_b7_Name}6 sobre el bajo de ${iiName}. Esto crea un sonido más complejo, un color diferente.`,
                        standardChord: { name: `${iiName}m7`, notes: std_ii_notes },
                        harrisChord: { name: `${ii_b7_Name}6 / ${iiName}`, notes: [ii_bass, ...c2_notes], chordNotes: c2_notes, bassNote: ii_bass, inversions: getChordInversions(c2_notes) }
                    },
                    {
                        title: `3. El Acorde V (${VName}7)`,
                        subtitle: `Sustitución: ${V_5_Name}m6 (6ª menor en la 5ª)`,
                        description: `Para un sonido ${VName}9, usamos un ${V_5_Name}m6 sobre el bajo de ${VName}. El ${V_5_Name}m6 añade la 9ª y la 3ª al acorde de ${VName}7.`,
                        standardChord: { name: `${VName}7`, notes: std_V_notes },
                        harrisChord: { name: `${V_5_Name}m6 / ${VName}`, notes: [V_bass, ...c3_notes], chordNotes: c3_notes, bassNote: V_bass, inversions: getChordInversions(c3_notes) }
                    },
                    {
                        title: `4. El Acorde V (${VName}7)`,
                        subtitle: `Sustitución: ${V_b7_Name}6 (6ª mayor en la b7)`,
                        description: `Para un sonido ${VName}7sus4, usamos un ${V_b7_Name}6 sobre el bajo de ${VName}. El acorde de ${V_b7_Name}6 introduce la 4ª y elimina la 3ª.`,
                        standardChord: { name: `${VName}7`, notes: std_V_notes },
                        harrisChord: { name: `${V_b7_Name}6 / ${VName}`, notes: [V_bass, ...c4_notes], chordNotes: c4_notes, bassNote: V_bass, inversions: getChordInversions(c4_notes) }
                    },
                    {
                        title: `5. El Acorde V (${VName}7)`,
                        subtitle: `Sustitución: ${V_b7_Name}m6 (6ª menor en la b7)`,
                        description: `Para más tensión (${VName}7sus4(b9)), usamos ${V_b7_Name}m6 sobre ${VName}. El ${V_b7_Name}m6 introduce la 4ª y la b9.`,
                        standardChord: { name: `${VName}7`, notes: std_V_notes },
                        harrisChord: { name: `${V_b7_Name}m6 / ${VName}`, notes: [V_bass, ...c5_notes], chordNotes: c5_notes, bassNote: V_bass, inversions: getChordInversions(c5_notes) }
                    },
                    {
                        title: `6. El Acorde V (${VName}7)`,
                        subtitle: `Sustitución: ${V_b2_Name}m6 (6ª menor en la b2)`,
                        description: `Para tensión máxima (${VName}7alt), usamos ${V_b2_Name}m6 sobre ${VName}. Esto introduce la b9 y la #5. ¡Una sustitución muy poderosa!`,
                        standardChord: { name: `${VName}7`, notes: std_V_notes },
                        harrisChord: { name: `${V_b2_Name}m6 / ${VName}`, notes: [V_bass, ...c6_notes], chordNotes: c6_notes, bassNote: V_bass, inversions: getChordInversions(c6_notes) }
                    },
                    {
                        title: `7. El Acorde I (${IName})`,
                        subtitle: `Sustitución: ${IName}6 (Tónica de Harris)`,
                        description: `El sistema de Harris resuelve por defecto al acorde de 6ª Mayor (${IName}6) en lugar del Maj7.`,
                        standardChord: { name: `${IName}maj7`, notes: std_I_notes },
                        harrisChord: { name: `${IName}6`, notes: [I_bass, ...c7_notes], chordNotes: c7_notes, bassNote: I_bass, inversions: getChordInversions(c7_notes) }
                    },
                    {
                        title: `8. El Acorde I (${IName})`,
                        subtitle: `Sustitución: ${I_5_Name}6 (6ª mayor en la 5ª)`,
                        description: `Para una resolución más rica (${IName}maj9), usamos un ${I_5_Name}6 sobre el bajo de ${IName}. Esto añade la 9ª al acorde de ${IName}.`,
                        standardChord: { name: `${IName}maj7`, notes: std_I_notes },
                        harrisChord: { name: `${I_5_Name}6 / ${IName}`, notes: [I_bass, ...c8_notes], chordNotes: c8_notes, bassNote: I_bass, inversions: getChordInversions(c8_notes) }
                    }
                ];
            }
            
            function loadConcept251(index) {
                if (!concepts251 || concepts251.length === 0 || index < 0 || index >= concepts251.length) return;
                const concept = concepts251[index];
                
                conceptTitleEl251.textContent = concept.title;
                conceptSubtitleEl251.textContent = concept.subtitle;
                conceptDescriptionEl251.textContent = concept.description;
                btnStandard251.textContent = `Oír ${concept.standardChord.name}`;
                btnHarris251.textContent = `Oír ${concept.harrisChord.name}`;
                stepIndicator251.textContent = `Paso ${index + 1} de ${concepts251.length}`;
                
                highlightKeys(pianoContainer251); 
                inversionControls251.classList.add('hidden'); 
                
                btnPrev251.disabled = (index === 0);
                btnNext251.disabled = (index === concepts251.length - 1);
            }

            function updateApp251() {
                const selectedKey = keySelect251.value;
                const baseNote = KEY_ROOT_NOTES[selectedKey];
                concepts251 = generateConcepts251(baseNote);
                currentConceptIndex251 = 0;
                loadConcept251(currentConceptIndex251);
                inversionControls251.classList.add('hidden'); 
            }

            btnPrev251.addEventListener('click', () => {
                if (currentConceptIndex251 > 0) {
                    currentConceptIndex251--;
                    loadConcept251(currentConceptIndex251);
                }
            });

            btnNext251.addEventListener('click', () => {
                if (currentConceptIndex251 < concepts251.length - 1) {
                    currentConceptIndex251++;
                    loadConcept251(currentConceptIndex251);
                }
            });

            btnStandard251.addEventListener('click', () => {
                const concept = concepts251[currentConceptIndex251];
                highlightKeys(pianoContainer251, concept.standardChord.notes);
                playChord(concept.standardChord.notes); 
                inversionControls251.classList.add('hidden'); 
            });

            btnHarris251.addEventListener('click', () => {
                const concept = concepts251[currentConceptIndex251];
                highlightKeys(pianoContainer251, concept.harrisChord.notes, concept.harrisChord.bassNote);
                playChord(concept.harrisChord.notes); 
                inversionControls251.classList.remove('hidden'); 
            });

            keySelect251.addEventListener('change', updateApp251);

            function playInversion(invIndex) {
                const concept = concepts251[currentConceptIndex251];
                if (!concept || !concept.harrisChord.inversions) return;
                const inversionNotes = concept.harrisChord.inversions[invIndex];
                highlightKeys(pianoContainer251, inversionNotes);
                playChord(inversionNotes);
            }

            btnInv1.addEventListener('click', () => playInversion(0));
            btnInv2.addEventListener('click', () => playInversion(1));
            btnInv3.addEventListener('click', () => playInversion(2));
            btnInv4.addEventListener('click', () => playInversion(3));

            
            // --- LÓGICA SECCIÓN 2: CONCEPTOS FUNDAMENTALES ---
            
            let currentDiminishedConcepts = {};
            
            function getMajor6DiminishedScale(rootNote) {
                const maj6Chord = [rootNote, transpose(rootNote, 4), transpose(rootNote, 7), transpose(rootNote, 9)]; 
                 const relatedDimRoot = transpose(rootNote, -1); 
                 const relatedDim = [relatedDimRoot, transpose(relatedDimRoot, 3), transpose(relatedDimRoot, 6), transpose(relatedDimRoot, 9)]; 
                
                const scale = [...maj6Chord, ...relatedDim];
                scale.sort((a, b) => ALL_NOTES.indexOf(a) - ALL_NOTES.indexOf(b));
                return scale; // C3, D3, E3, F3, G3, Ab3, A3, B3
            }

            function getMinor6DiminishedScale(rootNote) {
                const min6Chord = [rootNote, transpose(rootNote, 3), transpose(rootNote, 7), transpose(rootNote, 9)]; 
                 const relatedDimRoot = transpose(rootNote, -1); 
                 const relatedDim = [relatedDimRoot, transpose(relatedDimRoot, 3), transpose(relatedDimRoot, 6), transpose(relatedDimRoot, 9)]; 
                
                const scale = [...min6Chord, ...relatedDim];
                scale.sort((a, b) => ALL_NOTES.indexOf(a) - ALL_NOTES.indexOf(b));
                return scale; // C3, D3, Eb3, F3, G3, Ab3, A3, B3
            }


            function generateDiminishedConcepts(keyTonic) { // C, Db, D
                 const baseNote = SCALE_KEY_ROOT_NOTES[keyTonic]; // C3, Db3, D3
                
                const baseDimChord = [baseNote, transpose(baseNote, 3), transpose(baseNote, 6), transpose(baseNote, 9)];
                const upDimChord = [transpose(baseNote, 1), transpose(baseNote, 4), transpose(baseNote, 7), transpose(baseNote, 10)];
                const downDimChord = [transpose(baseNote, -1), transpose(baseNote, 2), transpose(baseNote, 5), transpose(baseNote, 8)];
                
                const generatedDominants = [
                    { 
                        name: `${getNoteName(downDimChord[0])}7`, 
                        notes: [downDimChord[0], baseDimChord[1], baseDimChord[2], baseDimChord[3]], 
                        bass: transpose(downDimChord[0], -12), 
                        desc: `(Bajar ${getNoteName(baseDimChord[0])} a ${getNoteName(downDimChord[0])})` 
                    },
                    { 
                        name: `${getNoteName(downDimChord[1])}7`, 
                        notes: [baseDimChord[0], downDimChord[1], baseDimChord[2], baseDimChord[3]], 
                        bass: transpose(downDimChord[1], -12), 
                        desc: `(Bajar ${getNoteName(baseDimChord[1])} a ${getNoteName(downDimChord[1])})`
                    },
                    { 
                        name: `${getNoteName(downDimChord[2])}7`, 
                        notes: [baseDimChord[0], baseDimChord[1], downDimChord[2], baseDimChord[3]], 
                        bass: transpose(downDimChord[2], -12), 
                        desc: `(Bajar ${getNoteName(baseDimChord[2])} a ${getNoteName(downDimChord[2])})`
                    },
                    { 
                        name: `${getNoteName(downDimChord[3])}7`, 
                        notes: [baseDimChord[0], baseDimChord[1], baseDimChord[2], downDimChord[3]], 
                        bass: transpose(downDimChord[3], -12), 
                        desc: `(Bajar ${getNoteName(baseDimChord[3])} a ${getNoteName(downDimChord[3])})`
                    }
                ];

                const generatedM7b5s = [
                    { 
                         name: `${getNoteName(transpose(baseDimChord[0], 2))}m7b5`, // C -> Dm7b5
                         notes: [upDimChord[0], baseDimChord[1], baseDimChord[2], baseDimChord[3]], 
                         bass: transpose(transpose(baseDimChord[0], 2), -12), // Bajo D2
                         desc: `(Subir ${getNoteName(baseDimChord[0])} a ${getNoteName(upDimChord[0])})` 
                    },
                     { 
                         name: `${getNoteName(transpose(baseDimChord[1], 2))}m7b5`, // Eb -> Fm7b5
                         notes: [baseDimChord[0], upDimChord[1], baseDimChord[2], baseDimChord[3]], 
                         bass: transpose(transpose(baseDimChord[1], 2), -12), // Bajo F2
                         desc: `(Subir ${getNoteName(baseDimChord[1])} a ${getNoteName(upDimChord[1])})`
                     },
                     { 
                         name: `${getNoteName(transpose(baseDimChord[2], 2))}m7b5`, // Gb -> Abm7b5
                         notes: [baseDimChord[0], baseDimChord[1], upDimChord[2], baseDimChord[3]], 
                         bass: transpose(transpose(baseDimChord[2], 2), -12), // Bajo Ab2
                         desc: `(Subir ${getNoteName(baseDimChord[2])} a ${getNoteName(upDimChord[2])})`
                     },
                     { 
                         name: `${getNoteName(transpose(baseDimChord[3], 2))}m7b5`, // A -> Bm7b5
                         notes: [baseDimChord[0], baseDimChord[1], baseDimChord[2], upDimChord[3]], 
                         bass: transpose(transpose(baseDimChord[3], 2), -12), // Bajo B2
                         desc: `(Subir ${getNoteName(baseDimChord[3])} a ${getNoteName(upDimChord[3])})`
                     }
                ];
                
                return {
                    baseDimChord,
                    upDimChord,
                    downDimChord,
                    generatedDominants,
                    generatedM7b5s
                };
            }
            
            function updateAppDiminished() {
                const selectedKey = keySelectDiminished.value; // C, Db, D
                currentDiminishedConcepts = generateDiminishedConcepts(selectedKey);
                
                highlightKeys(pianoContainerDiminished);

                btnDimUp.textContent = currentDiminishedConcepts.upDimChord.map(getNoteName).join(' - ');
                btnDimBase.textContent = currentDiminishedConcepts.baseDimChord.map(getNoteName).join(' - ');
                btnDimDown.textContent = currentDiminishedConcepts.downDimChord.map(getNoteName).join(' - ');

                domButtonsContainer.innerHTML = '';
                currentDiminishedConcepts.generatedDominants.forEach((chord) => {
                    const button = document.createElement('button');
                    button.className = 'w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-3 rounded-lg text-left transition-all';
                    button.innerHTML = `Oír <strong class="text-cyan-300">${chord.name}</strong> <span class="text-xs text-gray-400">${chord.desc}</span>`;
                    button.addEventListener('click', () => {
                        const notesToPlay = [chord.bass, ...chord.notes];
                        highlightKeys(pianoContainerDiminished, notesToPlay, chord.bass);
                        playChord(notesToPlay);
                    });
                    domButtonsContainer.appendChild(button);
                });

                m7b5ButtonsContainer.innerHTML = '';
                currentDiminishedConcepts.generatedM7b5s.forEach((chord) => {
                    const button = document.createElement('button');
                    button.className = 'w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-3 rounded-lg text-left transition-all';
                    button.innerHTML = `Oír <strong class="text-cyan-300">${chord.name}</strong> <span class="text-xs text-gray-400">${chord.desc}</span>`;
                    button.addEventListener('click', () => {
                        const notesToPlay = [chord.bass, ...chord.notes];
                        highlightKeys(pianoContainerDiminished, notesToPlay, chord.bass);
                        playChord(notesToPlay);
                    });
                    m7b5ButtonsContainer.appendChild(button);
                });
            }
            
            btnDimBase.addEventListener('click', () => {
                const chord = currentDiminishedConcepts.baseDimChord;
                highlightKeys(pianoContainerDiminished, chord);
                playChord(chord);
            });
            
            btnDimUp.addEventListener('click', () => {
                const chord = currentDiminishedConcepts.upDimChord;
                highlightKeys(pianoContainerDiminished, chord);
                playChord(chord);
            });

            btnDimDown.addEventListener('click', () => {
                const chord = currentDiminishedConcepts.downDimChord;
                highlightKeys(pianoContainerDiminished, chord);
                playChord(chord);
            });

            keySelectDiminished.addEventListener('change', updateAppDiminished);

            btnMaj6DimScale.addEventListener('click', () => {
                const root = SCALE_KEY_ROOT_NOTES[keySelectScales.value];
                const scale = getMajor6DiminishedScale(root);
                // Convertir a formato {note, isExtra: false} para playAnimatedScale
                 const scaleInfo = scale.map(note => ({note, isExtra: false}));
                 playAnimatedScale(scaleInfo, pianoContainerDiminished);
            });

            btnMin6DimScale.addEventListener('click', () => {
                const root = SCALE_KEY_ROOT_NOTES[keySelectScales.value];
                const scale = getMinor6DiminishedScale(root);
                 const scaleInfo = scale.map(note => ({note, isExtra: false}));
                 playAnimatedScale(scaleInfo, pianoContainerDiminished);
            });
            
            keySelectScales.addEventListener('change', () => {
                highlightKeys(pianoContainerDiminished);
            });

            // Highlight genérico
             function highlightKeys(container, notes = [], bassNote = null) {
                if (!container) return; // Safety check
                container.querySelectorAll('.piano-key').forEach(key => {
                    key.classList.remove('highlighted', 'highlighted-bass', 'highlighted-extra'); // Limpiar todos
                });

                notes.forEach(note => {
                    const keyEl = container.querySelector(`.piano-key[data-note="${note}"]`);
                    if (keyEl) {
                        const isBass = note === bassNote;
                        keyEl.classList.add(isBass ? 'highlighted-bass' : 'highlighted');
                    }
                });

                let noteDisplay;
                if (container.id === 'piano-container-251') {
                    noteDisplay = noteDisplay251;
                } else if (container.id === 'piano-container-diminished') {
                    noteDisplay = noteDisplayDiminished;
                } else if (container.id === 'piano-container-impro') {
                    noteDisplay = noteDisplayImpro;
                }

                if (noteDisplay) {
                    noteDisplay.textContent = notes.length > 0 ? `Notas: ${notes.map(getNoteName).join(', ')}` : '';
                }
            }


            // --- INICIALIZACIÓN ---
            // Llamar a drawPiano globalmente
            drawPiano(pianoContainer251);
            drawPiano(pianoContainerDiminished);
            drawPiano(pianoContainerImpro); 
            
            updateApp251(); 
            updateAppDiminished(); 
            updateImproControls(); 

        });
    </script>
</body>
</html>

