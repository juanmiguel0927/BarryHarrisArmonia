<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Explorador de Armonía 2-5-1 (Sistema Harris)</title>
    <!-- Cargar Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos personalizados para el piano */
        .piano-container {
            position: relative;
            width: 100%; /* Ajusta el ancho para que quepa en el contenedor */
            height: 140px; /* Reduje la altura para que las negras queden bien */
            background-color: #333; /* Fondo oscuro del piano */
            border-radius: 5px;
            overflow: hidden;
            box-shadow: inset 0 -2px 5px rgba(0,0,0,0.5);
            padding-left: 5px; /* Pequeño padding para el inicio */
            padding-right: 5px;
            box-sizing: border-box; /* Para incluir padding en el ancho */
        }
        .key-group {
            position: relative;
            height: 100%;
            display: flex;
        }
        .white-key {
            background-color: white;
            border: 1px solid #ccc;
            border-top: none;
            width: 40px; /* Ancho de tecla blanca ajustado */
            height: 100%;
            position: absolute; /* CORREGIDO: Debe ser absolute */
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            z-index: 1; /* Las blancas debajo de las negras */
            display: flex; /* Para alinear la etiqueta */
            justify-content: center;
            align-items: flex-end;
            padding-bottom: 5px;
            box-sizing: border-box;
            color: #333;
            font-size: 10px;
            font-weight: bold;
        }
        .black-key {
            background-color: #333;
            border: 1px solid #222;
            border-top: none;
            width: 25px; /* Ancho de tecla negra ajustado */
            height: 65%; /* Altura de la tecla negra */
            position: absolute;
            top: 0;
            z-index: 2; /* Las negras encima de las blancas */
            box-shadow: 0 1px 3px rgba(0,0,0,0.5);
            border-radius: 0 0 3px 3px;
        }

        /* Colores de resaltado */
        .highlighted { background-color: #06b6d4; } /* Cyan 600 */
        .highlighted-bass { background-color: #f97316; } /* Orange 500 */
        
        .white-key.highlighted { background-color: #06b6d4; color: white; }
        .black-key.highlighted { background-color: #06b6d4; }
        .white-key.highlighted-bass { background-color: #f97316; color: white; }
        .black-key.highlighted-bass { background-color: #f97316; }

        /* Etiqueta de nota */
        .note-label {
            pointer-events: none; /* Para que no interfiera con los clics */
        }

        /* Display de notas */
        .note-display {
            text-align: center;
            color: #cbd5e1; /* gray-300 */
            font-size: 0.875rem;
            margin-top: 0.75rem;
            height: 1.25rem; /* Altura fija para evitar saltos */
        }

        /* Deshabilitar botones */
        .nav-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Para el scroll horizontal */
        .piano-scroll-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch; /* Para un scroll más suave en móviles */
        }

        /* Estilos de Pestañas */
        .tab-button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem 0.5rem 0 0;
            background-color: #374151; /* gray-700 */
            color: #d1d5db; /* gray-300 */
            border: 1px solid #4b5563; /* gray-600 */
            border-bottom: none;
            cursor: pointer;
            font-weight: 600;
        }
        .tab-button.active {
            background-color: #1f2937; /* gray-800 */
            color: #67e8f9; /* cyan-300 */
            border-bottom: 1px solid #1f2937; /* Para que se fusione con el fondo */
            position: relative;
            top: 1px;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }

    </style>
</head>
<body class="bg-gray-900 text-gray-100 font-sans p-4 md:p-8">

    <div class="max-w-4xl mx-auto">
        
        <!-- Título -->
        <h1 class="text-3xl font-bold text-center mb-2 text-cyan-300">Explorador de Armonía de Barry Harris</h1>
        
        <!-- Pestañas de Navegación -->
        <div class="flex mb-0">
            <button id="tab-btn-251" class="tab-button active" data-tab="page-251">
                Explorador 2-5-1 (Aplicación)
            </button>
            <button id="tab-btn-diminished" class="tab-button" data-tab="page-diminished">
                Conceptos Fundamentales (Teoría)
            </button>
        </div>

        <!-- =========== SECCIÓN 1: EXPLORADOR 2-5-1 (Contenido existente) =========== -->
        <div id="page-251" class="tab-content active bg-gray-800 p-6 rounded-b-lg rounded-tr-lg shadow-xl mb-6">
            <h2 class="text-xl text-center text-gray-400 mb-4">Sustituciones de Acordes 2-5-1</h2>

            <!-- Selector de Tonalidad -->
            <div class="mb-6 max-w-xs mx-auto">
                <label for="key-select-251" class="block text-sm font-medium text-gray-400 mb-2 text-center">Selecciona la Tonalidad (I):</label>
                <select id="key-select-251" class="bg-gray-700 border border-gray-600 text-white text-lg rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block w-full p-2.5">
                    <option value="C">C</option>
                    <option value="Db">Db / C#</option>
                    <option value="D">D</option>
                    <option value="Eb">Eb</option>
                    <option value="E">E</option>
                    <option value="F" selected>F</option>
                    <option value="Gb">Gb / F#</option>
                    <option value="G">G</option>
                    <option value="Ab">Ab</option>
                    <option value="A">A</option>
                    <option value="Bb">Bb</option>
                    <option value="B">B / Cb</option>
                </select>
            </div>

            <!-- Tarjeta Principal del Concepto -->
            <div class="bg-gray-800 rounded-lg mb-6">
                
                <!-- Títulos del Concepto -->
                <h3 id="concept-title-251" class="text-2xl font-semibold text-white mb-2"></h3>
                <p id="concept-subtitle-251" class="text-lg text-cyan-400 mb-4"></p>
                <p id="concept-description-251" class="text-gray-300 mb-6"></p>

                <!-- Botones de Acordes -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <button id="btn-standard-251" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg flex-1 transition-all">
                        Oír Acorde Estándar
                    </button>
                    <button id="btn-harris-251" class="bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 px-4 rounded-lg flex-1 transition-all">
                        Oír Sustitución de Harris
                    </button>
                </div>

                <!-- Visualizador de Piano -->
                <div class="bg-gray-700 p-4 rounded-lg">
                    <p class="text-sm text-gray-400 mb-4">Visualizador de Teclado (Rango: C3 - G5)</p>
                    <div class="piano-scroll-container">
                        <div id="piano-container-251" class="piano-container">
                            <!-- Las teclas del piano se generarán aquí con JS -->
                        </div>
                    </div>
                    <!-- NUEVO: Note Display -->
                    <div id="note-display-251" class="note-display"></div>
                    <div class="flex justify-start gap-4 mt-2 text-sm"> <!-- margen mt-2 en lugar de mt-4 -->
                        <div class="flex items-center"><div class="w-4 h-4 rounded bg-cyan-600 mr-2"></div>Nota del Acorde</div>
                        <div class="flex items-center"><div class="w-4 h-4 rounded bg-orange-500 mr-2"></div>Nota del Bajo</div>
                    </div>
                </div>

            </div>

            <!-- Navegación -->
            <div class="flex justify-between items-center">
                <button id="btn-prev-251" class="nav-button bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-lg transition-all">
                    &larr; Anterior
                </button>
                <div id="step-indicator-251" class="text-gray-400"></div>
                <button id="btn-next-251" class="nav-button bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-lg transition-all">
                    Siguiente &rarr;
                </button>
            </div>
        </div>
        <!-- =========== FIN SECCIÓN 1 =========== -->


        <!-- =========== SECCIÓN 2: CONCEPTOS FUNDAMENTALES (Nuevo) =========== -->
        <div id="page-diminished" class="tab-content bg-gray-800 p-6 rounded-b-lg rounded-tr-lg shadow-xl mb-6">
            <h2 class="text-xl text-center text-gray-400 mb-4">El Decodificador de Acordes Disminuidos</h2>

            <!-- Selector de Familia Disminuida -->
            <div class="mb-6 max-w-sm mx-auto">
                <label for="key-select-diminished" class="block text-sm font-medium text-gray-400 mb-2 text-center">Selecciona una Familia Disminuida (Base):</label>
                <select id="key-select-diminished" class="bg-gray-700 border border-gray-600 text-white text-lg rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block w-full p-2.5">
                    <option value="C" selected>Cdim7 (C, Eb, Gb, A)</option>
                    <option value="Db">C#dim7 (C#, E, G, Bb)</option>
                    <option value="D">Ddim7 (D, F, Ab, B)</option>
                </select>
            </div>

            <!-- Tarjeta Principal del Concepto -->
            <div class="bg-gray-800 rounded-lg mb-6">
                
                <!-- Explicación de las 3 Familias -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 text-center">
                    <div class="bg-gray-700 p-3 rounded-lg">
                        <h4 class="text-sm font-semibold text-gray-400">Familia "Arriba" (iiø)</h4>
                        <button id="btn-dim-up" class="w-full text-lg font-bold text-cyan-300 py-2 px-3 rounded-lg hover:bg-gray-600 transition-all"></button>
                    </div>
                    <div class="bg-gray-900 border-2 border-cyan-500 p-3 rounded-lg">
                        <h4 class="text-sm font-semibold text-cyan-300">Familia "Base" (dim7)</h4>
                        <button id="btn-dim-base" class="w-full text-lg font-bold text-white py-2 px-3 rounded-lg hover:bg-gray-600 transition-all"></button>
                    </div>
                    <div class="bg-gray-700 p-3 rounded-lg">
                        <h4 class="text-sm font-semibold text-gray-400">Familia "Abajo" (V7)</h4>
                        <button id="btn-dim-down" class="w-full text-lg font-bold text-cyan-300 py-2 px-3 rounded-lg hover:bg-gray-600 transition-all"></button>
                    </div>
                </div>
                
                <p class="text-gray-300 mb-6 text-center">
                    Toma la familia "Base" y "toma prestada" una nota de las familias vecinas (arriba o abajo) para generar nuevos acordes.
                </p>

                <!-- Botones de Acordes Generados (Granular) -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-gray-700 p-4 rounded-lg">
                        <h4 class="text-lg font-semibold text-white mb-3 text-center">Generar Familia V7 (Bajar una nota)</h4>
                        <p class="text-sm text-gray-400 text-center mb-3">Toma una nota de la "Base" y bájala 1/2 tono a una nota de la familia "Abajo".</p>
                        <div id="dominant-buttons-container" class="space-y-2">
                            <!-- Los botones se generan aquí con JS -->
                        </div>
                    </div>
                    
                    <div class="bg-gray-700 p-4 rounded-lg">
                        <h4 class="text-lg font-semibold text-white mb-3 text-center">Generar Familia m7b5 (Subir una nota)</h4>
                        <p class="text-sm text-gray-400 text-center mb-3">Toma una nota de la "Base" y súbela 1/2 tono a una nota de la familia "Arriba".</p>
                        <div id="m7b5-buttons-container" class="space-y-2">
                            <!-- Los botones se generan aquí con JS -->
                        </div>
                    </div>
                </div>

                <!-- NUEVA SECCIÓN: ESCALAS 6 DIMINISHED -->
                <div class="bg-gray-700 p-4 rounded-lg mt-6">
                    <h4 class="text-lg font-semibold text-white mb-3 text-center">Las Escalas de 8 Notas (6 Diminished)</h4>
                    <p class="text-sm text-gray-400 text-center mb-4">El corazón del sistema: un acorde de 6ª (Mayor o Menor) combinado con un acorde disminuido.</p>
                    <div class="mb-4 max-w-xs mx-auto">
                        <label for="key-select-scales" class="block text-sm font-medium text-gray-400 mb-2 text-center">Selecciona una Tónica:</label>
                        <select id="key-select-scales" class="bg-gray-600 border border-gray-500 text-white text-lg rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block w-full p-2.5">
                            <option value="C" selected>C</option>
                            <option value="Db">Db / C#</option>
                            <option value="D">D</option>
                            <option value="Eb">Eb</option>
                            <option value="E">E</option>
                            <option value="F">F</option>
                            <option value="Gb">Gb / F#</option>
                            <option value="G">G</option>
                            <option value="Ab">Ab</option>
                            <option value="A">A</option>
                            <option value="Bb">Bb</option>
                            <option value="B">B / Cb</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <button id="btn-maj6-dim-scale" class="bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 px-4 rounded-lg flex-1 transition-all">
                            Oír Escala Major 6 Diminished
                        </button>
                        <button id="btn-min6-dim-scale" class="bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 px-4 rounded-lg flex-1 transition-all">
                            Oír Escala minor 6 Diminished
                        </button>
                    </div>
                </div>


                <!-- Visualizador de Piano -->
                <div class="bg-gray-700 p-4 rounded-lg mt-6"> <!-- Añadido margen superior -->
                    <p class="text-sm text-gray-400 mb-4">Visualizador de Teclado (Rango: C3 - G5)</p>
                    <div class="piano-scroll-container">
                        <div id="piano-container-diminished" class="piano-container">
                            <!-- Las teclas del piano se generarán aquí con JS -->
                        </div>
                    </div>
                    <!-- NUEVO: Note Display -->
                    <div id="note-display-diminished" class="note-display"></div>
                    <div class="flex justify-start gap-4 mt-2 text-sm">
                        <div class="flex items-center"><div class="w-4 h-4 rounded bg-cyan-600 mr-2"></div>Nota del Acorde</div>
                        <div class="flex items-center"><div class="w-4 h-4 rounded bg-orange-500 mr-2"></div>Nota del Bajo</div>
                    </div>
                </div>

            </div>
        </div>
        <!-- =========== FIN SECCIÓN 2 =========== -->

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- UTILIDADES GLOBALES DE TEORÍA Y AUDIO ---
            let audioCtx = null;
            const oscillatorType = 'triangle'; 
            const noteFrequencies = {
                'C2': 65.41, 'Db2': 69.30, 'D2': 73.42, 'Eb2': 77.78, 'E2': 82.41, 'F2': 87.31, 'Gb2': 92.50, 'G2': 98.00, 'Ab2': 103.83, 'A2': 110.00, 'Bb2': 116.54, 'B2': 123.47,
                'C3': 130.81, 'Db3': 138.59, 'D3': 146.83, 'Eb3': 155.56, 'E3': 164.81, 'F3': 174.61, 'Gb3': 185.00, 'G3': 196.00, 'Ab3': 207.65, 'A3': 220.00, 'Bb3': 233.08, 'B3': 246.94,
                'C4': 261.63, 'Db4': 277.18, 'D4': 293.66, 'Eb4': 311.13, 'E4': 329.63, 'F4': 349.23, 'Gb4': 369.99, 'G4': 392.00, 'Ab4': 415.30, 'A4': 440.00, 'Bb4': 466.16, 'B4': 493.88,
                'C5': 523.25, 'Db5': 554.37, 'D5': 587.33, 'Eb5': 622.25, 'E5': 659.25, 'F5': 698.46, 'Gb5': 739.99, 'G5': 783.99, 'Ab5': 830.61, 'A5': 880.00, 'Bb5': 932.33, 'B5': 987.77
            };
            const ALL_NOTES = Object.keys(noteFrequencies);
            const KEY_ROOT_NOTES = { // Nota base para cada tonalidad (en octava 3)
                'C': 'C3', 'Db': 'Db3', 'D': 'D3', 'Eb': 'Eb3', 'E': 'E3', 'F': 'F3',
                'Gb': 'Gb3', 'G': 'G3', 'Ab': 'Ab3', 'A': 'A3', 'Bb': 'Bb3', 'B': 'B3'
            };
            
            // --- Declaraciones de Elementos del DOM ---
            // Globales
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            
            // Sección 1 (2-5-1)
            const pianoContainer251 = document.getElementById('piano-container-251');
            const noteDisplay251 = document.getElementById('note-display-251'); // NUEVO
            const conceptTitleEl251 = document.getElementById('concept-title-251');
            const conceptSubtitleEl251 = document.getElementById('concept-subtitle-251');
            const conceptDescriptionEl251 = document.getElementById('concept-description-251');
            const btnStandard251 = document.getElementById('btn-standard-251');
            const btnHarris251 = document.getElementById('btn-harris-251');
            const btnPrev251 = document.getElementById('btn-prev-251');
            const btnNext251 = document.getElementById('btn-next-251');
            const stepIndicator251 = document.getElementById('step-indicator-251');
            const keySelect251 = document.getElementById('key-select-251');

            // Sección 2 (Diminished)
            const pianoContainerDiminished = document.getElementById('piano-container-diminished');
            const noteDisplayDiminished = document.getElementById('note-display-diminished'); // NUEVO
            const keySelectDiminished = document.getElementById('key-select-diminished');
            const domButtonsContainer = document.getElementById('dominant-buttons-container');
            const m7b5ButtonsContainer = document.getElementById('m7b5-buttons-container');
            const btnDimUp = document.getElementById('btn-dim-up');
            const btnDimBase = document.getElementById('btn-dim-base');
            const btnDimDown = document.getElementById('btn-dim-down');
            // NUEVO para Escalas
            const keySelectScales = document.getElementById('key-select-scales');
            const btnMaj6DimScale = document.getElementById('btn-maj6-dim-scale');
            const btnMin6DimScale = document.getElementById('btn-min6-dim-scale');


            // --- Funciones de Utilidad ---
            function getNoteName(note) {
                return note.slice(0, -1).replace(/[0-9]/, '');
            }

            function transpose(note, semitones) {
                const index = ALL_NOTES.indexOf(note);
                if (index === -1) {
                    console.error("Nota no encontrada en el mapa:", note);
                    return note;
                }
                const newIndex = index + semitones;
                if (newIndex >= 0 && newIndex < ALL_NOTES.length) {
                    return ALL_NOTES[newIndex];
                } else {
                    console.warn(`Transposición fuera de rango: ${note} + ${semitones}`);
                    const fallbackIndex = (index % 12) + semitones + 24; 
                    return ALL_NOTES[fallbackIndex] || note;
                }
            }
            
            function getFrequency(note) {
                return noteFrequencies[note] || 0;
            }

            function playChord(notes, duration = 1.5, startTime = 0) {
                if (!audioCtx) {
                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                }

                const scheduledTime = audioCtx.currentTime + startTime;
                const gain = 0.3 / notes.length;

                notes.forEach(note => {
                    const freq = getFrequency(note);
                    if (freq === 0) return; 

                    const oscillator = audioCtx.createOscillator();
                    const gainNode = audioCtx.createGain();

                    oscillator.type = oscillatorType;
                    oscillator.frequency.setValueAtTime(freq, scheduledTime);
                    
                    gainNode.gain.setValueAtTime(gain, scheduledTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.0001, scheduledTime + duration);

                    oscillator.connect(gainNode);
                    gainNode.connect(audioCtx.destination);

                    oscillator.start(scheduledTime);
                    oscillator.stop(scheduledTime + duration);
                });
            }

            function playScale(notes) {
                if (!audioCtx) {
                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                }
                const duration = 0.3;
                notes.forEach((note, index) => {
                    playChord([note], duration, index * duration);
                });
                // Tocar acorde final
                playChord(notes, 1.5, notes.length * duration);
            }

            // Mapeo de notas a su posición relativa en el piano
            const notePositions = {
                'C3': { white: 0 }, 'Db3': { black: 25 }, 'D3': { white: 40 }, 'Eb3': { black: 65 }, 'E3': { white: 80 },
                'F3': { white: 120 }, 'Gb3': { black: 145 }, 'G3': { white: 160 }, 'Ab3': { black: 185 }, 'A3': { white: 200 }, 'Bb3': { black: 225 }, 'B3': { white: 240 },
                'C4': { white: 280 }, 'Db4': { black: 305 }, 'D4': { white: 320 }, 'Eb4': { black: 345 }, 'E4': { white: 360 },
                'F4': { white: 400 }, 'Gb4': { black: 425 }, 'G4': { white: 440 }, 'Ab4': { black: 465 }, 'A4': { white: 480 }, 'Bb4': { black: 505 }, 'B4': { white: 520 },
                'C5': { white: 560 }, 'Db5': { black: 585 }, 'D5': { white: 600 }, 'Eb5': { black: 625 }, 'E5': { white: 640 },
                'F5': { white: 680 }, 'Gb5': { black: 705 }, 'G5': { white: 720 },
                'G2': { white: -1000 }, 'C2': { white: -1040 }, 'F2': { white: -1080 }
            };
            const whiteNotesOrder = ['C3', 'D3', 'E3', 'F3', 'G3', 'A3', 'B3', 'C4', 'D4', 'E4', 'F4', 'G4', 'A4', 'B4', 'C5', 'D5', 'E5', 'F5', 'G5'];
            const blackNotesOrder = ['Db3', 'Eb3', 'Gb3', 'Ab3', 'Bb3', 'Db4', 'Eb4', 'Gb4', 'Ab4', 'Bb4', 'Db5', 'Eb5', 'Gb5'];

            /**
             * Función genérica para dibujar un piano en un contenedor
             * @param {HTMLElement} container - El elemento div que contendrá el piano
             */
            function drawPiano(container) {
                container.innerHTML = ''; // Limpiar

                whiteNotesOrder.forEach(note => {
                    const keyEl = document.createElement('div');
                    keyEl.className = `piano-key white-key`;
                    keyEl.dataset.note = note;
                    keyEl.style.left = `${notePositions[note].white}px`;
                    
                    // NUEVO: Añadir etiqueta de nota
                    const label = document.createElement('span');
                    label.className = 'note-label';
                    label.textContent = getNoteName(note);
                    keyEl.appendChild(label);

                    container.appendChild(keyEl);
                });

                blackNotesOrder.forEach(note => {
                    const keyEl = document.createElement('div');
                    keyEl.className = `piano-key black-key`;
                    keyEl.dataset.note = note;
                    keyEl.style.left = `${notePositions[note].black}px`;
                    container.appendChild(keyEl);
                });

                const lastWhiteKeyOffset = notePositions['G5'].white;
                container.style.width = `${lastWhiteKeyOffset + 40 + 10}px`;
            }

            /**
             * Función genérica para resaltar teclas en un contenedor de piano
             * @param {HTMLElement} container - El elemento div que contiene el piano
             * @param {string[]} notes - Array de notas a resaltar (ej: ['C3', 'E3', 'G3'])
             * @param {string} bassNote - La nota bajo (opcional)
             */
            function highlightKeys(container, notes = [], bassNote = null) {
                container.querySelectorAll('.piano-key').forEach(key => {
                    key.classList.remove('highlighted', 'highlighted-bass');
                });

                notes.forEach(note => {
                    const keyEl = container.querySelector(`.piano-key[data-note="${note}"]`);
                    if (keyEl) {
                        const isBass = note === bassNote;
                        keyEl.classList.add(isBass ? 'highlighted-bass' : 'highlighted');
                    }
                });

                // NUEVO: Actualizar el display de notas
                let noteDisplay;
                if (container.id === 'piano-container-251') {
                    noteDisplay = noteDisplay251;
                } else if (container.id === 'piano-container-diminished') {
                    noteDisplay = noteDisplayDiminished;
                }

                if (noteDisplay) {
                    noteDisplay.textContent = notes.length > 0 ? `Notas: ${notes.map(getNoteName).join(', ')}` : '';
                }
            }


            // --- LÓGICA DE PESTAÑAS (TABS) ---
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tabId = button.dataset.tab;

                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');

                    tabContents.forEach(content => {
                        if (content.id === tabId) {
                            content.classList.add('active');
                        } else {
                            content.classList.remove('active');
                        }
                    });
                });
            });


            // --- LÓGICA SECCIÓN 1: EXPLORADOR 2-5-1 ---
            
            let concepts251 = [];
            let currentConceptIndex251 = 0;

            function generateConcepts251(keyTonic) {
                const ii_root_note = transpose(keyTonic, 2);   // G3 (para F)
                const V_root_note = transpose(keyTonic, 7);    // C4 (para F)
                const I_root_note = keyTonic;                // F3 (para F)

                const ii_bass = transpose(ii_root_note, -12); // G2
                const V_bass = transpose(V_root_note, -12);   // C3
                const I_bass = transpose(I_root_note, -12);   // F2

                const iiName = getNoteName(ii_root_note); 
                const VName = getNoteName(V_root_note);   
                const IName = getNoteName(I_root_note);   
                
                const ii_b3_note = transpose(ii_root_note, 3); 
                const ii_b3_Name = getNoteName(ii_b3_note);   
                
                const ii_b7_note = transpose(ii_root_note, 10); 
                const ii_b7_Name = getNoteName(ii_b7_note);   

                const V_5_note = transpose(V_root_note, 7);   
                const V_5_Name = getNoteName(V_5_note);     
                
                const V_b7_note = transpose(V_root_note, 10); 
                const V_b7_Name = getNoteName(V_b7_note);    

                const V_b2_note = transpose(V_root_note, 1);  
                const V_b2_Name = getNoteName(V_b2_note);    

                const I_5_note = transpose(I_root_note, 7);   
                const I_5_Name = getNoteName(I_5_note);     

                return [
                    {
                        title: `1. El Acorde II (${iiName}m7)`,
                        subtitle: `Sustitución: ${ii_b3_Name}6 (Sexta Mayor Relativa)`,
                        description: `En lugar de ${iiName}m7, usamos un ${ii_b3_Name}6. ¡Son las mismas notas! El sistema de Harris prefiere el acorde de 6ª. El bajo se mantiene en ${iiName}.`,
                        standardChord: { name: `${iiName}m7`, notes: [ii_root_note, transpose(ii_root_note, 3), transpose(ii_root_note, 7), transpose(ii_root_note, 10)] },
                        harrisChord: { name: `${ii_b3_Name}6 / ${iiName}`, notes: [ii_bass, ii_b3_note, transpose(ii_b3_note, 4), transpose(ii_b3_note, 7), transpose(ii_b3_note, 9)], bassNote: ii_bass }
                    },
                    {
                        title: `2. El Acorde II (${iiName}m7)`,
                        subtitle: `Sustitución: ${ii_b7_Name}6 (Desde el Menor Importante)`,
                        description: `Otra opción para el II (${iiName}m7) es usar un ${ii_b7_Name}6 sobre el bajo de ${iiName}. Esto crea un sonido más complejo, un color diferente.`,
                        standardChord: { name: `${iiName}m7`, notes: [ii_root_note, transpose(ii_root_note, 3), transpose(ii_root_note, 7), transpose(ii_root_note, 10)] },
                        harrisChord: { name: `${ii_b7_Name}6 / ${iiName}`, notes: [ii_bass, ii_b7_note, transpose(ii_b7_note, 4), transpose(ii_b7_note, 7), transpose(ii_b7_note, 9)], bassNote: ii_bass }
                    },
                    {
                        title: `3. El Acorde V (${VName}7)`,
                        subtitle: `Sustitución: ${V_5_Name}m6 (6ª menor en la 5ª)`,
                        description: `Para un sonido ${VName}9, usamos un ${V_5_Name}m6 sobre el bajo de ${VName}. El ${V_5_Name}m6 añade la 9ª y la 3ª al acorde de ${VName}7.`,
                        standardChord: { name: `${VName}7`, notes: [V_root_note, transpose(V_root_note, 4), transpose(V_root_note, 7), transpose(V_root_note, 10)] },
                        harrisChord: { name: `${V_5_Name}m6 / ${VName}`, notes: [V_bass, V_5_note, transpose(V_5_note, 3), transpose(V_5_note, 7), transpose(V_5_note, 9)], bassNote: V_bass }
                    },
                    {
                        title: `4. El Acorde V (${VName}7)`,
                        subtitle: `Sustitución: ${V_b7_Name}6 (6ª mayor en la b7)`,
                        description: `Para un sonido ${VName}7sus4, usamos un ${V_b7_Name}6 sobre el bajo de ${VName}. El acorde de ${V_b7_Name}6 introduce la 4ª y elimina la 3ª.`,
                        standardChord: { name: `${VName}7`, notes: [V_root_note, transpose(V_root_note, 4), transpose(V_root_note, 7), transpose(V_root_note, 10)] },
                        harrisChord: { name: `${V_b7_Name}6 / ${VName}`, notes: [V_bass, V_b7_note, transpose(V_b7_note, 4), transpose(V_b7_note, 7), transpose(V_b7_note, 9)], bassNote: V_bass }
                    },
                    {
                        title: `5. El Acorde V (${VName}7)`,
                        subtitle: `Sustitución: ${V_b7_Name}m6 (6ª menor en la b7)`,
                        description: `Para más tensión (${VName}7sus4(b9)), usamos ${V_b7_Name}m6 sobre ${VName}. El ${V_b7_Name}m6 introduce la 4ª y la b9.`,
                        standardChord: { name: `${VName}7`, notes: [V_root_note, transpose(V_root_note, 4), transpose(V_root_note, 7), transpose(V_root_note, 10)] },
                        harrisChord: { name: `${V_b7_Name}m6 / ${VName}`, notes: [V_bass, V_b7_note, transpose(V_b7_note, 3), transpose(V_b7_note, 7), transpose(V_b7_note, 9)], bassNote: V_bass }
                    },
                    {
                        title: `6. El Acorde V (${VName}7)`,
                        subtitle: `Sustitución: ${V_b2_Name}m6 (6ª menor en la b2)`,
                        description: `Para tensión máxima (${VName}7alt), usamos ${V_b2_Name}m6 sobre ${VName}. Esto introduce la b9 y la #5. ¡Una sustitución muy poderosa!`,
                        standardChord: { name: `${VName}7`, notes: [V_root_note, transpose(V_root_note, 4), transpose(V_root_note, 7), transpose(V_root_note, 10)] },
                        harrisChord: { name: `${V_b2_Name}m6 / ${VName}`, notes: [V_bass, V_b2_note, transpose(V_b2_note, 3), transpose(V_b2_note, 7), transpose(V_b2_note, 9)], bassNote: V_bass }
                    },
                    {
                        title: `7. El Acorde I (${IName})`,
                        subtitle: `Sustitución: ${IName}6 (Tónica de Harris)`,
                        description: `El sistema de Harris resuelve por defecto al acorde de 6ª Mayor (${IName}6) en lugar del Maj7.`,
                        standardChord: { name: `${IName}maj7`, notes: [I_root_note, transpose(I_root_note, 4), transpose(I_root_note, 7), transpose(I_root_note, 11)] },
                        harrisChord: { name: `${IName}6`, notes: [I_bass, I_root_note, transpose(I_root_note, 4), transpose(I_root_note, 7), transpose(I_root_note, 9)], bassNote: I_bass }
                    },
                    {
                        title: `8. El Acorde I (${IName})`,
                        subtitle: `Sustitución: ${I_5_Name}6 (6ª mayor en la 5ª)`,
                        description: `Para una resolución más rica (${IName}maj9), usamos un ${I_5_Name}6 sobre el bajo de ${IName}. Esto añade la 9ª al acorde de ${IName}.`,
                        standardChord: { name: `${IName}maj7`, notes: [I_root_note, transpose(I_root_note, 4), transpose(I_root_note, 7), transpose(I_root_note, 11)] },
                        harrisChord: { name: `${I_5_Name}6 / ${IName}`, notes: [I_bass, I_5_note, transpose(I_5_note, 4), transpose(I_5_note, 7), transpose(I_5_note, 9)], bassNote: I_bass }
                    }
                ];
            }
            
            function loadConcept251(index) {
                if (!concepts251 || concepts251.length === 0) return;
                const concept = concepts251[index];
                
                conceptTitleEl251.textContent = concept.title;
                conceptSubtitleEl251.textContent = concept.subtitle;
                conceptDescriptionEl251.textContent = concept.description;
                btnStandard251.textContent = `Oír ${concept.standardChord.name}`;
                btnHarris251.textContent = `Oír ${concept.harrisChord.name}`;
                stepIndicator251.textContent = `Paso ${index + 1} de ${concepts251.length}`;
                
                highlightKeys(pianoContainer251); // Limpiar piano
                
                btnPrev251.disabled = (index === 0);
                btnNext251.disabled = (index === concepts251.length - 1);
            }

            function updateApp251() {
                const selectedKey = keySelect251.value;
                const baseNote = KEY_ROOT_NOTES[selectedKey];
                concepts251 = generateConcepts251(baseNote);
                currentConceptIndex251 = 0;
                loadConcept251(currentConceptIndex251);
            }

            btnPrev251.addEventListener('click', () => {
                if (currentConceptIndex251 > 0) {
                    currentConceptIndex251--;
                    loadConcept251(currentConceptIndex251);
                }
            });

            btnNext251.addEventListener('click', () => {
                if (currentConceptIndex251 < concepts251.length - 1) {
                    currentConceptIndex251++;
                    loadConcept251(currentConceptIndex251);
                }
            });

            btnStandard251.addEventListener('click', () => {
                const concept = concepts251[currentConceptIndex251];
                highlightKeys(pianoContainer251, concept.standardChord.notes);
                playChord(concept.standardChord.notes); 
            });

            btnHarris251.addEventListener('click', () => {
                const concept = concepts251[currentConceptIndex251];
                highlightKeys(pianoContainer251, concept.harrisChord.notes, concept.harrisChord.bassNote);
                playChord(concept.harrisChord.notes); 
            });

            keySelect251.addEventListener('change', updateApp251);
            
            // --- LÓGICA SECCIÓN 2: CONCEPTOS FUNDAMENTALES ---
            
            let currentDiminishedConcepts = {};

            function getMajor6DiminishedScale(rootNote) {
                const maj6Chord = [rootNote, transpose(rootNote, 4), transpose(rootNote, 7), transpose(rootNote, 9)]; // C, E, G, A
                const relatedDim = [transpose(rootNote, 2), transpose(rootNote, 5), transpose(rootNote, 8), transpose(rootNote, 11)]; // D, F, Ab, B
                const scale = [...maj6Chord, ...relatedDim];
                scale.sort((a, b) => ALL_NOTES.indexOf(a) - ALL_NOTES.indexOf(b));
                return scale; // C, D, E, F, G, Ab, A, B
            }

            function getMinor6DiminishedScale(rootNote) {
                const min6Chord = [rootNote, transpose(rootNote, 3), transpose(rootNote, 7), transpose(rootNote, 9)]; // C, Eb, G, A
                const relatedDim = [transpose(rootNote, 2), transpose(rootNote, 5), transpose(rootNote, 8), transpose(rootNote, 11)]; // D, F, Ab, B (Mismo acorde dim.)
                const scale = [...min6Chord, ...relatedDim];
                scale.sort((a, b) => ALL_NOTES.indexOf(a) - ALL_NOTES.indexOf(b));
                return scale; // C, D, Eb, F, G, Ab, A, B
            }


            function generateDiminishedConcepts(keyTonic) {
                const baseNote = KEY_ROOT_NOTES[keyTonic]; // C3, Db3, or D3
                
                // 1. Definir las 3 Familias de Acordes
                const baseDimChord = [baseNote, transpose(baseNote, 3), transpose(baseNote, 6), transpose(baseNote, 9)];
                const upDimChord = [transpose(baseNote, 1), transpose(baseNote, 4), transpose(baseNote, 7), transpose(baseNote, 10)];
                const downDimChord = [transpose(baseNote, -1), transpose(baseNote, 2), transpose(baseNote, 5), transpose(baseNote, 8)];
                
                // 2. Generar Familia Dominante (Base - 1 nota)
                // (Bajar una nota de la Base a una de la familia de Abajo)
                const generatedDominants = [
                    { 
                        name: `${getNoteName(downDimChord[0])}7`, 
                        notes: [downDimChord[0], baseDimChord[1], baseDimChord[2], baseDimChord[3]], 
                        bass: downDimChord[0],
                        desc: `(Bajar ${getNoteName(baseDimChord[0])} a ${getNoteName(downDimChord[0])})` 
                    },
                    { 
                        name: `${getNoteName(downDimChord[1])}7`, 
                        notes: [baseDimChord[0], downDimChord[1], baseDimChord[2], baseDimChord[3]], 
                        bass: downDimChord[1],
                        desc: `(Bajar ${getNoteName(baseDimChord[1])} a ${getNoteName(downDimChord[1])})`
                    },
                    { 
                        name: `${getNoteName(downDimChord[2])}7`, 
                        notes: [baseDimChord[0], baseDimChord[1], downDimChord[2], baseDimChord[3]], 
                        bass: downDimChord[2],
                        desc: `(Bajar ${getNoteName(baseDimChord[2])} a ${getNoteName(downDimChord[2])})`
                    },
                    { 
                        name: `${getNoteName(downDimChord[3])}7`, 
                        notes: [baseDimChord[0], baseDimChord[1], baseDimChord[2], downDimChord[3]], 
                        bass: downDimChord[3],
                        desc: `(Bajar ${getNoteName(baseDimChord[3])} a ${getNoteName(downDimChord[3])})`
                    }
                ];

                // 3. Generar Familia m7b5 (Base + 1 nota)
                // (Subir una nota de la Base a una de la familia de Arriba)
                const generatedM7b5s = [
                    { 
                        name: `${getNoteName(transpose(baseDimChord[0], 2))}m7b5`, // C -> Dm7b5 (D,F,Ab,C). Root = D (+2)
                        notes: [upDimChord[0], baseDimChord[1], baseDimChord[2], baseDimChord[3]], 
                        bass: transpose(baseDimChord[0], 2),
                        desc: `(Subir ${getNoteName(baseDimChord[0])} a ${getNoteName(upDimChord[0])})` 
                    },
                    { 
                        name: `${getNoteName(transpose(baseDimChord[1], 2))}m7b5`, // Eb -> Fm7b5 (F,Ab,C,Eb). Root = F (+2)
                        notes: [baseDimChord[0], upDimChord[1], baseDimChord[2], baseDimChord[3]], 
                        bass: transpose(baseDimChord[1], 2),
                        desc: `(Subir ${getNoteName(baseDimChord[1])} a ${getNoteName(upDimChord[1])})`
                    },
                    { 
                        name: `${getNoteName(transpose(baseDimChord[2], 2))}m7b5`, // Gb -> Abm7b5 (Ab,C,Eb,Gb). Root = Ab (+2)
                        notes: [baseDimChord[0], baseDimChord[1], upDimChord[2], baseDimChord[3]], 
                        bass: transpose(baseDimChord[2], 2),
                        desc: `(Subir ${getNoteName(baseDimChord[2])} a ${getNoteName(upDimChord[2])})`
                    },
                    { 
                        name: `${getNoteName(transpose(baseDimChord[3], 2))}m7b5`, // A -> Bm7b5 (B,D,F,A). Root = B (+2)
                        notes: [baseDimChord[0], baseDimChord[1], baseDimChord[2], upDimChord[3]], 
                        bass: transpose(baseDimChord[3], 2),
                        desc: `(Subir ${getNoteName(baseDimChord[3])} a ${getNoteName(upDimChord[3])})`
                    }
                ];
                
                return {
                    baseDimChord,
                    upDimChord,
                    downDimChord,
                    generatedDominants,
                    generatedM7b5s
                };
            }
            
            function updateAppDiminished() {
                const selectedKey = keySelectDiminished.value; // C, Db, D
                currentDiminishedConcepts = generateDiminishedConcepts(selectedKey);
                
                // Limpiar el piano al cambiar
                highlightKeys(pianoContainerDiminished);

                // Poblar los botones de familia
                btnDimUp.textContent = currentDiminishedConcepts.upDimChord.map(getNoteName).join(' - ');
                btnDimBase.textContent = currentDiminishedConcepts.baseDimChord.map(getNoteName).join(' - ');
                btnDimDown.textContent = currentDiminishedConcepts.downDimChord.map(getNoteName).join(' - ');

                // Poblar los botones de Dominantes
                domButtonsContainer.innerHTML = '';
                currentDiminishedConcepts.generatedDominants.forEach((chord, index) => {
                    const button = document.createElement('button');
                    button.className = 'w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-3 rounded-lg text-left transition-all';
                    button.innerHTML = `Oír <strong class="text-cyan-300">${chord.name}</strong> <span class="text-xs text-gray-400">${chord.desc}</span>`;
                    button.addEventListener('click', () => {
                        highlightKeys(pianoContainerDiminished, chord.notes, chord.bass);
                        playChord(chord.notes);
                    });
                    domButtonsContainer.appendChild(button);
                });

                // Poblar los botones de m7b5
                m7b5ButtonsContainer.innerHTML = '';
                currentDiminishedConcepts.generatedM7b5s.forEach((chord, index) => {
                    const button = document.createElement('button');
                    button.className = 'w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-3 rounded-lg text-left transition-all';
                    button.innerHTML = `Oír <strong class="text-cyan-300">${chord.name}</strong> <span class="text-xs text-gray-400">${chord.desc}</span>`;
                    button.addEventListener('click', () => {
                        highlightKeys(pianoContainerDiminished, chord.notes, chord.bass);
                        playChord(chord.notes);
                    });
                    m7b5ButtonsContainer.appendChild(button);
                });
            }
            
            // Listeners para la sección 2 (Familias principales)
            btnDimBase.addEventListener('click', () => {
                const chord = currentDiminishedConcepts.baseDimChord;
                highlightKeys(pianoContainerDiminished, chord);
                playChord(chord);
            });
            
            btnDimUp.addEventListener('click', () => {
                const chord = currentDiminishedConcepts.upDimChord;
                highlightKeys(pianoContainerDiminished, chord);
                playChord(chord);
            });

            btnDimDown.addEventListener('click', () => {
                const chord = currentDiminishedConcepts.downDimChord;
                highlightKeys(pianoContainerDiminished, chord);
                playChord(chord);
            });

            keySelectDiminished.addEventListener('change', updateAppDiminished);

            // NUEVO: Listeners para Escalas
            btnMaj6DimScale.addEventListener('click', () => {
                const root = KEY_ROOT_NOTES[keySelectScales.value];
                const scale = getMajor6DiminishedScale(root);
                highlightKeys(pianoContainerDiminished, scale);
                playScale(scale);
            });

            btnMin6DimScale.addEventListener('click', () => {
                const root = KEY_ROOT_NOTES[keySelectScales.value];
                const scale = getMinor6DiminishedScale(root);
                highlightKeys(pianoContainerDiminished, scale);
                playScale(scale);
            });
            
            keySelectScales.addEventListener('change', () => {
                // Al cambiar el select, limpiar el piano
                highlightKeys(pianoContainerDiminished);
            });


            // --- INICIALIZACIÓN DE AMBAS SECCIONES ---
            drawPiano(pianoContainer251);
            updateApp251(); // Inicializa la pestaña 2-5-1
            
            drawPiano(pianoContainerDiminished);
            updateAppDiminished(); // Inicializa la pestaña de conceptos

        });
    </script>
</body>
</html>

