<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Explorador de Armonía e Improvisación (Sistema Harris)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #18181b; color: #e4e4e7; font-family: 'Segoe UI', sans-serif; }
        
        /* Piano */
        .piano-container { position: relative; width: 100%; height: 140px; background-color: #27272a; border-radius: 8px; overflow: hidden; box-shadow: inset 0 -4px 8px rgba(0,0,0,0.6); border-top: 4px solid #3f3f46; margin-bottom: 0.5rem; }
        .white-key { background: linear-gradient(to bottom, #ffffff 0%, #e0e0e0 100%); border: 1px solid #999; border-top: none; width: 40px; height: 100%; position: absolute; z-index: 1; display: flex; justify-content: center; align-items: flex-end; padding-bottom: 8px; font-size: 10px; font-weight: bold; color: #444; border-radius: 0 0 4px 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: background 0.05s; }
        .white-key.active { background: #ccc; transform: translateY(2px); }
        .black-key { background: linear-gradient(to bottom, #333 0%, #000 100%); border: 1px solid #000; width: 24px; height: 65%; position: absolute; top: 0; z-index: 2; border-radius: 0 0 4px 4px; box-shadow: 2px 2px 4px rgba(0,0,0,0.4); transition: background 0.05s; }
        
        /* Colores */
        .highlighted { background: #f59e0b !important; color: white !important; }
        .highlighted-bass { background: #0ea5e9 !important; color: white !important; }
        .highlighted-extra { background: #f43f5e !important; color: white !important; }
        .highlighted-dim { background: #a855f7 !important; color: white !important; }
        .black-key.highlighted { background: #d97706 !important; border-color: #b45309; }

        .note-display { text-align: center; color: #a1a1aa; font-family: monospace; font-size: 0.9rem; height: 1.5rem; }
        .piano-scroll-container { overflow-x: auto; padding-bottom: 5px; }

        /* Tabs */
        .tab-button-container { display: flex; flex-wrap: wrap; border-bottom: 2px solid #3f3f46; margin-bottom: 1.5rem; justify-content: center; gap: 4px; }
        .tab-btn { padding: 0.75rem 1.5rem; background: transparent; color: #a1a1aa; border-radius: 0.5rem 0.5rem 0 0; transition: all 0.2s; font-weight: 600; font-size: 0.95rem; cursor: pointer; border-bottom: 2px solid transparent; }
        .tab-btn:hover { color: #e4e4e7; background: #3f3f46; }
        .tab-btn.active { background: #27272a; color: #fcd34d; border-bottom-color: #fcd34d; }
        .tab-content { display: none; animation: fadeIn 0.3s ease-in-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Paneles */
        .control-panel { background-color: #27272a; padding: 1.5rem; border-radius: 0.75rem; border: 1px solid #3f3f46; margin-bottom: 1.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        select { background: #18181b; border: 1px solid #52525b; padding: 0.5rem; border-radius: 0.25rem; width: 100%; color: white; }
        label { display: block; font-size: 0.8rem; color: #a1a1aa; margin-bottom: 0.25rem; font-weight: 500; }
        
        .btn-action { background-color: #f59e0b; color: #18181b; font-weight: 800; padding: 0.75rem; border-radius: 0.5rem; width: 100%; text-transform: uppercase; font-size: 0.85rem; cursor: pointer; transition: transform 0.1s; }
        .btn-action:hover { background-color: #fbbf24; transform: translateY(-1px); }
        .btn-secondary { background: #3f3f46; color: #e4e4e7; padding: 0.5rem; border-radius: 0.375rem; border: 1px solid #52525b; cursor: pointer; font-size: 0.85rem; }
        .btn-secondary:hover { background: #52525b; border-color: #a1a1aa; }
        .btn-secondary.active { background: #0ea5e9; color: white; border-color: #0284c7; }
        
        .btn-stop { background: #dc2626; color: white; font-weight: bold; padding: 0.5rem 1rem; border-radius: 0.5rem; display: flex; align-items: center; gap: 0.5rem; transition: background 0.2s; cursor: pointer; }
        
        /* Grid */
        .chord-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 0.5rem; }
        .chord-cell { background: #3f3f46; padding: 0.5rem; text-align: center; border-radius: 0.25rem; cursor: pointer; font-size: 0.7rem; border: 1px solid transparent; min-height: 3rem; display: flex; align-items: center; justify-content: center; word-break: break-all; }
        .chord-cell:hover { border-color: #a1a1aa; }
        .chord-cell.playing { background: #f59e0b; color: black; font-weight: bold; transform: scale(1.05); }
        
        /* 2-5-1 Buttons */
        .sub-btn { width: 100%; text-align: left; padding: 1rem 0.75rem; background: #3f3f46; border-radius: 0.35rem; border: 1px solid transparent; font-size: 0.85rem; margin-bottom: 0.5rem; transition: all 0.2s; cursor: pointer; display: flex; flex-direction: column; justify-content: center; gap: 0.5rem; }
        .sub-btn:hover { background: #52525b; }
        .sub-btn.selected { background: #f59e0b; color: black; font-weight: bold; border-color: #f59e0b; }
        .sub-btn .chord-name { font-weight: bold; color: #fcd34d; font-size: 1rem; margin-bottom: 4px; display: block; }
        .sub-btn.selected .chord-name { color: black; }
        .sub-btn .chord-desc { font-size: 0.75rem; color: #a1a1aa; line-height: 1.4; display: block; }
        .sub-btn.selected .chord-desc { color: #374151; }
        .info-icon { font-size: 10px; width: 16px; height: 16px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-left: 5px; }
        
        /* Fraseo */
        .formula-card { background: #18181b; padding: 1rem; border-radius: 0.5rem; border: 1px solid #3f3f46; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; justify-content: space-between; }
        .formula-card:hover { border-color: #f59e0b; transform: translateY(-2px); }
        .formula-card h4 { color: #f59e0b; font-weight: bold; margin-bottom: 0.25rem; }
        
        .phrase-timeline { display: flex; gap: 0.5rem; overflow-x: auto; padding: 0.5rem; background: #18181b; border-radius: 0.5rem; min-height: 60px; align-items: center; margin-bottom: 1rem; }
        .timeline-item { background: #3f3f46; padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.8rem; white-space: nowrap; display: flex; align-items: center; gap: 0.5rem; border: 1px solid #52525b; }
        .timeline-item span { cursor: pointer; color: #f87171; font-weight: bold; }
        
        .info-box { background-color: #3f3f46; border-left: 4px solid #0ea5e9; padding: 1rem; margin-bottom: 1rem; border-radius: 0.25rem; }
        .info-box p { font-size: 0.85rem; color: #e4e4e7; margin-bottom: 0.5rem; }
        .info-box ul { list-style: disc; margin-left: 1.5rem; font-size: 0.8rem; color: #a1a1aa; }
        
        /* Diminished Organic UI */
        .dim-controls { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-top: 1.5rem; }
        .dim-note-col { display: flex; flex-direction: column; align-items: center; gap: 0.5rem; }
        .dim-btn-action { width: 100%; padding: 0.5rem; border-radius: 0.25rem; font-size: 1rem; font-weight: bold; transition: all 0.2s; cursor: pointer; border: 1px solid #52525b; background: #3f3f46; color: #e4e4e7; text-align: center; }
        .dim-btn-action.up { color: #4ade80; border-color: #166534; }
        .dim-btn-action.up:hover { background: #14532d; }
        .dim-btn-action.down { color: #60a5fa; border-color: #1e40af; }
        .dim-btn-action.down:hover { background: #1e3a8a; }
        .dim-note-display { width: 3.5rem; height: 3.5rem; border-radius: 50%; background: #18181b; border: 2px solid #a855f7; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #a855f7; font-size: 1.2rem; }
        #dim-reset-container { display: none; margin-top: 1rem; text-align: center; }
        .tritone-btn { padding: 0.5rem; background: #27272a; border: 1px solid #f59e0b; color: #f59e0b; font-weight: bold; font-size: 0.8rem; border-radius: 0.3rem; transition: all 0.2s; text-align: center; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 4px; }
        .tritone-btn:hover { background: #3f3f46; color: #fff; }

        /* Franja de Análisis */
        .analysis-strip { background: #000; border: 1px solid #3f3f46; padding: 1rem; margin-bottom: 1rem; text-align: center; min-height: 80px; display: flex; flex-direction: column; justify-content: center; border-radius: 0.5rem; font-size: 0.9rem; gap: 0.5rem; }
        .analysis-text { color: #fcd34d; font-family: monospace; width: 100%; }
        .analysis-row { border-bottom: 1px solid #333; padding-bottom: 4px; display: flex; }
        .analysis-label { width: 30px; color: #a1a1aa; font-weight: bold; }
        .analysis-content { flex: 1; color: #e4e4e7; text-align: left; padding-left: 10px; }

        /* Modal */
        .modal { display: none; position: fixed; z-index: 50; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); backdrop-filter: blur(4px); }
        .modal-content { background-color: #27272a; margin: 15% auto; padding: 2rem; border: 1px solid #52525b; width: 90%; max-width: 500px; border-radius: 0.75rem; }
        .close { float: right; font-size: 28px; cursor: pointer; color: #a1a1aa; }
    </style>
</head>
<body class="bg-zinc-900 text-zinc-100 font-sans p-4 md:p-8 min-h-screen">

    <div class="max-w-6xl mx-auto">
        <header class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
            <div>
                <h1 class="text-3xl md:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-amber-400 to-orange-500 mb-2">Barry Harris Explorer</h1>
                <p class="text-zinc-400 font-medium">Herramienta integral de Armonía, Voicings y Fraseo Bebop</p>
            </div>
            <button onclick="stopAll()" class="btn-stop shadow-lg bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded flex items-center gap-2">
                <span>■</span> DETENER TODO
            </button>
        </header>

        <div class="tab-button-container">
            <button class="tab-btn active" onclick="showTab('scales', this)">1. Escalas</button>
            <button class="tab-btn" onclick="showTab('chords', this)">2. Voicings</button>
            <button class="tab-btn" onclick="showTab('phrasing', this)">3. Fraseo</button>
            <button class="tab-btn" onclick="showTab('subs', this)">4. Sustituciones</button>
            <button class="tab-btn" onclick="showTab('diminished', this)">5. El Disminuido</button>
        </div>

        <!-- TAB 1: ESCALAS -->
        <div id="tab-scales" class="tab-content block">
            <div class="control-panel">
                <h3 class="section-title text-xl font-bold text-amber-400 mb-4">Generador de Escalas (Reglas PDF)</h3>
                <div id="scale-explanation" class="info-box">
                    <p><strong>Reglas de Inserción Cromática (Para caer a tiempo):</strong></p>
                    <ul id="rules-desc">
                        <li>Selecciona una regla abajo...</li>
                    </ul>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                    <div>
                        <label>Tónica</label>
                        <select id="scale-root">
                            <option value="C">C</option><option value="F">F</option><option value="Bb">Bb</option><option value="Eb">Eb</option>
                            <option value="Ab">Ab</option><option value="Db">Db</option><option value="G">G</option><option value="D">D</option>
                            <option value="A">A</option><option value="E">E</option><option value="B">B</option><option value="Gb">Gb</option>
                        </select>
                    </div>
                    <div>
                        <label>Tipo de Escala</label>
                        <select id="scale-type">
                            <option value="dominant">Dominante 7</option>
                            <option value="major6dim">Mayor 6ta Disminuida</option>
                            <option value="minor6dim">Menor 6ta Disminuida</option>
                        </select>
                    </div>
                    <div>
                        <label>Grado de Inicio</label>
                        <select id="scale-start-degree" onchange="updateExtraNoteOptions()">
                            <option value="1">1 (Impar/Tónica)</option><option value="2">2 (Par)</option><option value="3">3 (Impar)</option><option value="4">4 (Par)</option>
                            <option value="5">5 (Impar)</option><option value="6">6 (Par)</option><option value="7">7 (Impar)</option><option value="8">8 (Tónica)</option>
                        </select>
                    </div>
                    <div>
                        <label>Regla</label>
                        <select id="extra-notes-rule" onchange="updateRuleDesc()"></select>
                    </div>
                </div>
                <button onclick="playScale()" class="btn-action">Reproducir Escala Descendente</button>
            </div>
            <div class="bg-zinc-950 p-4 rounded-lg border border-zinc-800 shadow-xl">
                <div class="piano-scroll-container"><div id="piano-sc" class="piano-container"></div></div>
                <div id="disp-sc" class="note-display">Selecciona una escala...</div>
            </div>
        </div>

        <!-- TAB 2: VOICINGS -->
        <div id="tab-chords" class="tab-content hidden">
            <div class="control-panel">
                <h3 class="section-title text-xl font-bold text-amber-400 mb-4">Escalas de Acordes</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                    <div>
                        <label>Tónica</label>
                        <select id="ch-root" onchange="updateChordGrid()"><option value="C">C</option><option value="F">F</option><option value="Bb">Bb</option><option value="Eb">Eb</option><option value="Ab">Ab</option><option value="G">G</option><option value="D">D</option><option value="A">A</option><option value="E">E</option></select>
                    </div>
                    <div class="md:col-span-2">
                        <label>Escala</label>
                        <select id="ch-type" onchange="updateChordGrid()">
                            <option value="major6dim">Mayor 6ta Disminuida</option>
                            <option value="minor6dim">Menor 6ta Disminuida</option>
                            <option value="dominantDim">Dominante Disminuida</option>
                        </select>
                    </div>
                    <div>
                        <label>Voicing</label>
                        <div class="flex gap-2 bg-zinc-900 p-1 rounded-md border border-zinc-600">
                            <button id="v-closed" onclick="setVoicingType('closed')" class="btn-secondary active flex-1">Cerrado</button>
                            <button id="v-drop2" onclick="setVoicingType('drop2')" class="btn-secondary flex-1">Drop 2</button>
                        </div>
                    </div>
                </div>
                <div id="chord-grid" class="chord-grid mb-6"></div>
                <button onclick="playChordScale()" class="btn-action">Tocar Escala Completa (Ida y Vuelta)</button>
            </div>
            <div class="bg-zinc-950 p-4 rounded-lg border border-zinc-800 shadow-xl">
                <div class="piano-scroll-container"><div id="piano-ch" class="piano-container"></div></div>
                <div id="disp-ch" class="note-display"></div>
            </div>
        </div>

        <!-- TAB 3: FRASEO -->
        <div id="tab-phrasing" class="tab-content hidden">
            <div class="control-panel">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <h3 class="text-xl font-bold text-amber-400">Constructor de Frases (Builder)</h3>
                    <div class="flex flex-col md:flex-row gap-4 w-full md:w-auto">
                        <select id="ph-root" class="w-full md:w-24 py-1 text-sm bg-zinc-800 border-amber-500 text-amber-500 font-bold" onchange="clearTimeline()">
                            <option value="C">C7</option><option value="F">F7</option><option value="Bb">Bb7</option><option value="G">G7</option><option value="D">D7</option>
                        </select>
                         <select id="ph-start-note" class="w-full md:w-48 py-1 text-sm bg-zinc-800 border-amber-500 text-amber-500 font-bold">
                            <option value="0">Empezar en: Tónica</option>
                            <option value="1">Empezar en: 2da / 9na</option>
                            <option value="2">Empezar en: 3ra</option>
                            <option value="3">Empezar en: 4ta / 11na</option>
                            <option value="4">Empezar en: 5ta</option>
                            <option value="5">Empezar en: 6ta / 13na</option>
                            <option value="6">Empezar en: 7ma</option>
                        </select>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="mb-2 text-sm text-zinc-400">Línea de Tiempo (Las tarjetas añaden, pero NO suenan hasta reproducir):</label>
                    <div id="phrase-timeline" class="phrase-timeline"><span class="text-zinc-600 text-sm italic ml-2" id="timeline-placeholder">Vacío...</span></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 mb-6">
                    <div class="formula-card" onclick="addToTimeline(1, 'Escala Simple')"><h4>1. Escala Simple</h4><p>Descendente (Reglas)</p></div>
                    <div class="formula-card" onclick="addToTimeline(2, 'Arp+Escala')"><h4>2. Arpegio + Escala</h4><p>Arpegio Asc -> Escala Desc</p></div>
                    <div class="formula-card" onclick="addToTimeline(3, 'Tresillo')"><h4>3. Tresillo</h4><p>3 notas rápidas hacia tiempo fuerte</p></div>
                    <div class="formula-card" onclick="addToTimeline(4, 'Aproximación')"><h4>4. Aprox + Arp</h4><p>Semitono abajo -> Arpegio</p></div>
                    <div class="formula-card" onclick="addToTimeline(5, 'Pivot 5')"><h4>5. Pivot (BH)</h4><p>Escala Desc -> Salto -> Cont.</p></div>
                    <div class="formula-card border-amber-500/50" onclick="addToTimeline(6, 'Arp Pivot')"><h4>6. Arp. Pivote</h4><p>C5 E4 G4 B4 (ZigZag)</p></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                     <button onclick="playTimeline()" class="btn-action">Reproducir Frase</button>
                     <button onclick="clearTimeline()" class="btn-secondary text-red-400 border-red-900">Borrar Frase</button>
                </div>
            </div>
            <div class="bg-zinc-950 p-4 rounded-lg border border-zinc-800 shadow-xl">
                <div class="piano-scroll-container"><div id="piano-ph" class="piano-container"></div></div>
                <div id="disp-ph" class="note-display"></div>
            </div>
        </div>

        <!-- TAB 4: SUSTITUCIONES -->
        <div id="tab-subs" class="tab-content hidden">
            <div class="control-panel">
                <h3 class="section-title text-xl font-bold text-amber-400 mb-4">Sustituciones 2-5-1 (Análisis de Tensión)</h3>
                
                <div class="bg-zinc-800 p-3 mb-4 rounded border border-zinc-600 text-sm flex justify-around items-center">
                    <div class="text-center"><strong>Equivalencias:</strong></div>
                    <div class="text-center"><span class="text-sky-400">X6 = Xm7</span></div>
                    <div class="text-center"><span class="text-amber-400">Xm6 = Xm7(b5)</span></div>
                </div>

                <div class="flex flex-col md:flex-row gap-6 mb-6">
                    <div class="flex-1 text-center">
                        <label>Tonalidad</label>
                        <select id="sub-key" class="w-32 text-center font-bold bg-zinc-800 border-amber-500 text-amber-500" onchange="updateSubOptions()">
                            <option value="C">C Mayor</option><option value="Db">Db Mayor</option><option value="D">D Mayor</option><option value="Eb">Eb Mayor</option><option value="E">E Mayor</option><option value="F">F Mayor</option><option value="Gb">Gb Mayor</option><option value="G">G Mayor</option><option value="Ab">Ab Mayor</option><option value="A">A Mayor</option><option value="Bb">Bb Mayor</option><option value="B">B Mayor</option>
                        </select>
                    </div>
                    <div class="flex-1 text-center">
                        <label>Inversión Inicial del II</label>
                        <select id="start-inv" class="w-32 text-center bg-zinc-800 border-zinc-600 text-zinc-300">
                            <option value="0">Fundamental</option>
                            <option value="1">1ra Inv</option>
                            <option value="2">2da Inv</option>
                            <option value="3">3ra Inv</option>
                        </select>
                    </div>
                    <div class="flex-1 text-center">
                        <label>Bajo</label>
                        <div class="flex justify-center gap-2 mt-1">
                             <button id="bass-orig" class="px-3 py-1 text-xs rounded bg-blue-600 text-white border border-blue-500" onclick="setBassMode('orig')">Original (2-5-1)</button>
                             <button id="bass-sub" class="px-3 py-1 text-xs rounded bg-zinc-700 text-gray-300 border border-zinc-600" onclick="setBassMode('sub')">Del Sustituto</button>
                        </div>
                    </div>
                </div>
                
                <!-- FRANJA DE ANÁLISIS -->
                <div class="analysis-strip mb-6">
                     <div id="analysis-preview" class="w-full p-2 text-zinc-500 italic">Selecciona 3 acordes para ver el análisis...</div>
                </div>

                <div class="grid grid-cols-3 gap-4 mb-6">
                    <div class="bg-zinc-900 p-2 rounded border border-zinc-700"><h4 class="text-center text-sky-400 font-bold text-sm mb-4 pb-2 border-b border-zinc-700">II</h4><div id="col-ii" class="flex flex-col gap-2"></div></div>
                    <div class="bg-zinc-900 p-2 rounded border border-zinc-700"><h4 class="text-center text-fuchsia-400 font-bold text-sm mb-4 pb-2 border-b border-zinc-700">V</h4><div id="col-v" class="flex flex-col gap-2"></div></div>
                    <div class="bg-zinc-900 p-2 rounded border border-zinc-700"><h4 class="text-center text-lime-400 font-bold text-sm mb-4 pb-2 border-b border-zinc-700">I</h4><div id="col-i" class="flex flex-col gap-2"></div></div>
                </div>
                
                <div class="text-center">
                    <button onclick="playSelectedProgression()" class="btn-action w-auto px-10">Reproducir Progresión</button>
                </div>
            </div>
            <div class="bg-zinc-950 p-4 rounded-lg border border-zinc-800 shadow-xl">
                <div class="piano-scroll-container"><div id="piano-sb" class="piano-container"></div></div>
                <div id="disp-sb" class="note-display"></div>
            </div>
        </div>

        <!-- TAB 5: DIMINUIDO ORGANICO -->
        <div id="tab-diminished" class="tab-content hidden">
            <div class="control-panel">
                <h3 class="section-title text-xl font-bold text-amber-400 mb-4">El Disminuido</h3>
                <div class="info-box mb-6">
                    <p>Mueve cualquier voz del acorde disminuido para transformarlo.</p>
                </div>
                
                <div class="flex justify-center mb-6">
                    <select id="dim-root" class="w-40 text-center font-bold bg-zinc-800 border-amber-500 text-amber-500 p-2 rounded" onchange="updateDimOrganic()">
                        <option value="C">C°7</option><option value="C#">C#°7</option><option value="D">D°7</option>
                        <option value="Eb">Eb°7</option><option value="E">E°7</option><option value="F">F°7</option>
                        <option value="F#">F#°7</option><option value="G">G°7</option><option value="Ab">Ab°7</option>
                        <option value="A">A°7</option><option value="Bb">Bb°7</option><option value="B">B°7</option>
                    </select>
                </div>

                <!-- NEW: 7b5 Controls -->
                <div class="border-t border-b border-zinc-700 py-4 mb-6">
                    <h4 class="text-center text-sm font-bold text-zinc-400 mb-3 uppercase tracking-wider">Transformación Tritonal (7b5)</h4>
                    <div class="grid grid-cols-2 gap-4 max-w-md mx-auto">
                        <button onclick="transformTritone(0)" class="tritone-btn">
                            <span id="tri-lbl-0-main" class="text-lg">Subir Par 1</span>
                            <span id="tri-lbl-0-notes" class="text-[10px] font-normal opacity-75">Calculando...</span>
                        </button>
                        <button onclick="transformTritone(1)" class="tritone-btn">
                            <span id="tri-lbl-1-main" class="text-lg">Subir Par 2</span>
                            <span id="tri-lbl-1-notes" class="text-[10px] font-normal opacity-75">Calculando...</span>
                        </button>
                    </div>
                </div>

                <!-- ORGANIC INTERFACE -->
                <div id="dim-organic-container" class="dim-controls bg-zinc-900 p-4 rounded border border-zinc-700">
                    <!-- Injected via JS -->
                </div>
                <div id="dim-result-text" class="text-center mt-4 text-amber-300 font-bold min-h-[2rem] text-lg"></div>
                <div id="dim-reset-container">
                     <button onclick="updateDimOrganic()" class="btn-secondary text-xs">Volver al Acorde Base</button>
                </div>

            </div>
            <div class="bg-zinc-950 p-4 rounded-lg border border-zinc-800 shadow-xl">
                <div class="piano-scroll-container"><div id="piano-dm" class="piano-container"></div></div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="infoModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="document.getElementById('infoModal').style.display='none'">&times;</span>
            <h3 id="modal-title" class="text-xl font-bold text-amber-400 mb-2"></h3>
            <div id="modal-desc" class="text-zinc-300 text-sm leading-relaxed space-y-2"></div>
        </div>
    </div>

    <script>
        // --- CORE AUDIO ---
        const NOTES = ['C','Db','D','Eb','E','F','Gb','G','Ab','A','Bb','B'];
        const FREQUENCIES = {};
        for (let i = 24; i <= 108; i++) { 
            const n = NOTES[i%12];
            const o = Math.floor(i/12);
            FREQUENCIES[n+o] = 440 * Math.pow(2, (i - 57) / 12);
        }
        let audioCtx;
        let timeouts = [];

        function stopAll() {
            timeouts.forEach(clearTimeout);
            timeouts = [];
            document.querySelectorAll('.white-key, .black-key').forEach(k => k.className = k.className.replace(/active|highlighted[-\w]*/g, '').trim());
            document.querySelectorAll('.chord-cell').forEach(c => c.classList.remove('playing'));
            document.querySelectorAll('.note-display').forEach(d => d.innerText = '');
            if(document.getElementById('analysis-preview')) document.getElementById('analysis-preview').innerHTML = document.getElementById('analysis-preview').innerHTML; 
            if(document.getElementById('prog-feedback')) document.getElementById('prog-feedback').innerText = '';
        }

        function playTone(freq, start, dur) {
            if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'triangle';
            osc.frequency.value = freq;
            gain.gain.setValueAtTime(0, start);
            gain.gain.linearRampToValueAtTime(0.2, start + 0.01);
            gain.gain.exponentialRampToValueAtTime(0.001, start + dur);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start(start);
            osc.stop(start + dur + 0.1);
        }

        function playChord(notes, dur=1.5) {
            if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const now = audioCtx.currentTime;
            notes.forEach(n => { if(FREQUENCIES[n]) playTone(FREQUENCIES[n], now, dur); });
        }

        function getNoteIndex(n) { return (parseInt(n.slice(-1)) * 12) + NOTES.indexOf(n.slice(0,-1)); }
        function getNoteFromIndex(i) { return NOTES[i%12] + Math.floor(i/12); }
        function transpose(n, sem) { return getNoteFromIndex(getNoteIndex(n) + sem); }

        function drawPiano(id) {
            const c = document.getElementById(id);
            if(!c) return;
            c.innerHTML = '';
            let left = 0;
            for(let i=31; i<=84; i++) { // G1 to C6
                const n = getNoteFromIndex(i);
                const isBlack = n.includes('b');
                const k = document.createElement('div');
                k.dataset.note = n;
                if(!isBlack) {
                    k.className = 'white-key';
                    k.style.left = left + 'px';
                    if(i%12===0) k.innerHTML = `<span class="text-[8px] text-gray-500 mb-1">C${Math.floor(i/12)}</span>`;
                    c.appendChild(k);
                    left += 40;
                } else {
                    k.className = 'black-key';
                    k.style.left = (left - 14) + 'px';
                    c.appendChild(k);
                }
            }
            c.style.width = left + 'px';
            
            c.querySelectorAll('div').forEach(k => {
                k.onmousedown = () => {
                    if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    playTone(FREQUENCIES[k.dataset.note], audioCtx.currentTime, 0.5);
                    highlight(id, [k.dataset.note], null);
                    setTimeout(() => highlight(id, [], null), 500);
                }
            });
        }

        function highlight(id, notes, bassNote) {
            const c = document.getElementById(id);
            c.querySelectorAll('div').forEach(d => d.className = d.className.replace(/highlighted[-\w]*/g, '').trim());
            notes.forEach(n => {
                const k = c.querySelector(`div[data-note="${n}"]`);
                if(k) k.classList.add('highlighted');
            });
            if(bassNote) {
                 const kb = c.querySelector(`div[data-note="${bassNote}"]`);
                 if(kb) kb.classList.add('highlighted-bass');
            }
        }

        function showTab(id, btn) {
            document.querySelectorAll('.tab-content').forEach(d => d.style.display = 'none');
            document.getElementById('tab-'+id).style.display = 'block';
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const pid = id==='scales'?'piano-sc':id==='chords'?'piano-ch':id==='phrasing'?'piano-ph':id==='subs'?'piano-sb':'piano-dm';
            drawPiano(pid);
            if(id==='chords') updateChordGrid();
            if(id==='subs') updateSubOptions();
            if(id==='diminished') updateDimOrganic();
        }

        // --- TAB 1: ESCALAS ---
        function updateExtraNoteOptions() {
            const deg = parseInt(document.getElementById('scale-start-degree').value);
            const sel = document.getElementById('extra-notes-rule');
            sel.innerHTML = '';
            const isOdd = [1,3,5,7].includes(deg);
            
            if(isOdd) {
                sel.add(new Option("1 Nota Extra (1-7)", "1"));
                sel.add(new Option("3 Notas Extra (3-2, 2-1, 1-7)", "3"));
            } else {
                sel.add(new Option("0 Notas Extra", "0"));
                sel.add(new Option("2 Notas Extra (2-1, 1-7)", "2"));
            }
            updateRuleDesc();
        }
        
        function updateRuleDesc() {
            const rule = document.getElementById('extra-notes-rule').value;
            const desc = document.getElementById('rules-desc');
            let text = "";
            if(rule == '1') text = "<li><strong>Tónica (1):</strong> Se añade 1 nota entre la Tónica y la Séptima.</li>";
            if(rule == '2') text = "<li><strong>Pares (2,4,6):</strong> Se añaden 2 notas: entre 2da-Tónica y Tónica-7ma (2-1, 1-7).</li>";
            if(rule == '3') text = "<li><strong>Impares (3,5,7):</strong> Se añaden 3 notas: entre 3ra-2da, 2da-Tónica y Tónica-7ma.</li>";
            if(rule == '0') text = "<li><strong>Pares (2,4,6):</strong> Sin notas extra, la escala diatónica cae a tiempo.</li>";
            desc.innerHTML = text;
        }

        function getScaleNotes(root, type) {
            const r = getNoteIndex(root+'3');
            let i = [];
            if(type==='dominant') i=[0,2,4,5,7,9,10];
            if(type==='major6dim') i=[0,2,4,5,7,8,9,11];
            if(type==='minor6dim') i=[0,2,3,5,7,8,9,11]; 
            if(type==='dominantDim') i=[0,2,4,5,7,8,10,11]; 
            return i.map(x => getNoteFromIndex(r+x));
        }

        function playScale() {
            stopAll();
            if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const root = document.getElementById('scale-root').value;
            const type = document.getElementById('scale-type').value;
            const deg = parseInt(document.getElementById('scale-start-degree').value);
            const rule = document.getElementById('extra-notes-rule').value;

            let base = getScaleNotes(root, type);
            let startIdx = (deg - 1) % base.length;
            let rotated = [];
            for(let i=0; i<base.length; i++) rotated.push(base[(startIdx+i)%base.length]);
            for(let i=1; i<rotated.length; i++) if(getNoteIndex(rotated[i]) < getNoteIndex(rotated[i-1])) rotated[i] = transpose(rotated[i], 12);
            
            let desc = [...rotated].reverse();
            desc.unshift(transpose(desc[desc.length-1], 12));
            
            let final = [];
            const getDeg = (n) => {
                let nm = n.slice(0,-1);
                let idx = base.findIndex(b => b.slice(0,-1) === nm);
                return idx + 1;
            };

            for(let i=0; i<desc.length; i++) {
                let curr = desc[i];
                final.push({n:curr, x:false});
                let next = desc[i+1];
                if(!next) break;
                
                let dist = getNoteIndex(curr) - getNoteIndex(next);
                if(dist !== 2 && dist !== -10) continue; 

                let dCurr = getDeg(curr);
                let dNext = getDeg(next);
                
                let ins = false;
                if(rule === '1' && dCurr === 1 && dNext === 7) ins = true;
                if(rule === '1' && dCurr === 1 && dNext === 8) ins = true; 
                if(rule === '2' && ((dCurr === 2 && dNext === 1) || (dCurr === 1 && dNext === 7))) ins = true;
                if(rule === '3' && ((dCurr === 3 && dNext === 2) || (dCurr === 2 && dNext === 1) || (dCurr === 1 && dNext === 7))) ins = true;

                if(ins) final.push({n:transpose(curr,-1), x:true});
            }

            let t = 0;
            final.forEach(s => {
                timeouts.push(setTimeout(() => {
                    highlight('piano-sc', [s.n], null);
                    playTone(FREQUENCIES[s.n], audioCtx.currentTime, 0.2);
                    document.getElementById('disp-sc').innerText = `${s.n} ${s.x ? '(Extra)' : ''}`;
                }, t));
                t += 220;
            });
        }

        // --- TAB 2: VOICINGS (Force C3 Start - Octave Fix) ---
        let currVoicing = 'closed';
        function setVoicingType(v) {
            currVoicing = v;
            document.getElementById('v-closed').className = v==='closed' ? 'btn-secondary active flex-1' : 'btn-secondary flex-1';
            document.getElementById('v-drop2').className = v==='drop2' ? 'btn-secondary active flex-1' : 'btn-secondary flex-1';
            updateChordGrid();
        }

        function getVoicings(root, type) {
            const rIdx = getNoteIndex(root+'3'); 
            let ints = [];
            if(type==='major6dim') ints=[0,2,4,5,7,8,9,11];
            else if(type==='minor6dim') ints=[0,2,3,5,7,8,9,11];
            else ints=[0,2,4,5,7,8,10,11];
            
            let scaleBase = ints.map(x => getNoteFromIndex(rIdx+x));
            let scaleFull = [...scaleBase, ...scaleBase.map(n=>transpose(n,12))];
            
            let chords = [];
            for(let i=0; i<=8; i++) {
                let melody = scaleFull[i];
                let isDim = (i%2 !== 0);
                let notes = [];
                let name = "";

                if(!isDim) { // Tonic 6
                    let tones = [0,2,4,6].map(k => scaleBase[k].slice(0,-1));
                    notes = buildVoicing(tones, melody);
                    
                    // Exact Naming Logic
                    let bass = notes[0].slice(0,-1);
                    if(type === 'dominantDim') {
                        if(bass===root) name = `${root}7`;
                        else {
                            if(i%2 !== 0) name = `${bass}°7`;
                            else name = `${root}7/${bass}`;
                        }
                    } else {
                        name = type.includes('minor') ? `${root}m6` : `${root}6`;
                        if(bass!==root) name = `${name}/${bass}`;
                        if(bass==='A' && root==='C' && !type.includes('minor')) name = `${root}6/A(Am7)`;
                    }
                } else { // Dim
                    let tones = [1,3,5,7].map(k => scaleBase[k].slice(0,-1));
                    notes = buildVoicing(tones, melody);
                    let bass = notes[0].slice(0,-1);
                    name = `${bass}dim`;
                    if(type==='dominantDim') name = `${bass}°7`;
                }
                
                // FORCE C3 START (48)
                let low = getNoteIndex(notes[0]);
                if(i===0) {
                    while(low < 48) { notes = notes.map(n=>transpose(n,12)); low+=12; }
                    while(low >= 60) { notes = notes.map(n=>transpose(n,-12)); low-=12; }
                } else {
                    let prevLow = getNoteIndex(chords[i-1].notes[0]);
                    while(low < prevLow - 5) { notes = notes.map(n=>transpose(n,12)); low+=12; }
                    while(low > prevLow + 7) { notes = notes.map(n=>transpose(n,-12)); low-=12; }
                }
                chords.push({name, notes, isDim, melody});
            }
            return chords;
        }

        function buildVoicing(classes, melody) {
            let v = [melody];
            let c = melody;
            while(v.length < 4) {
                c = transpose(c, -1);
                if(classes.includes(c.slice(0,-1))) v.push(c);
            }
            v.reverse();
            if(currVoicing === 'drop2') {
                let d = v[2];
                v.splice(2,1);
                v.unshift(transpose(d, -12));
            }
            return v;
        }

        function updateChordGrid() {
            const root = document.getElementById('ch-root').value;
            const type = document.getElementById('ch-type').value;
            const div = document.getElementById('chord-grid');
            div.innerHTML = '';
            const chords = getVoicings(root, type);
            chords.slice(0,8).forEach((c, i) => { 
                let el = document.createElement('div');
                el.className = `chord-cell ${c.isDim?'border-purple-500 text-purple-400':'border-amber-500 text-amber-400'}`;
                el.innerHTML = `<span class="type text-xs">${c.name}</span>`;
                el.onclick = () => {
                    stopAll();
                    el.classList.add('playing');
                    highlight('piano-ch', c.notes, null);
                    playChord(c.notes);
                    document.getElementById('disp-ch').innerText = `${c.name}: ${c.notes.join(' ')}`;
                };
                div.appendChild(el);
            });
        }

        function playChordScale() {
            stopAll();
            const root = document.getElementById('ch-root').value;
            const type = document.getElementById('ch-type').value;
            const chords = getVoicings(root, type);
            let seq = [...chords, ...[...chords].reverse().slice(1, -1)];
            
            let t = 0;
            seq.forEach(c => {
                timeouts.push(setTimeout(() => {
                    highlight('piano-ch', c.notes, null);
                    playChord(c.notes);
                    document.getElementById('disp-ch').innerText = `${c.name}`;
                }, t));
                t += 500;
            });
        }

        // --- TAB 3: FRASEO ---
        let phraseQueue = [];
        
        function addToTimeline(id, name) { 
            let startIdx = parseInt(document.getElementById('ph-start-note').value);
            let offsets = [0, 2, 4, 5, 7, 9, 10];
            let shift = offsets[startIdx] || 0;
            let labelMap = ["Tónica", "2da", "3ra", "4ta", "5ta", "6ta", "7ma"];
            let label = labelMap[startIdx];
            
            phraseQueue.push({id, name, shift, label}); 
            renderTimeline(); 
        }

        function clearTimeline() { phraseQueue = []; renderTimeline(); }
        
        function renderTimeline() {
            const d = document.getElementById('phrase-timeline');
            d.innerHTML = phraseQueue.length ? '' : '<span class="text-zinc-600 text-sm italic ml-2">Añade fórmulas...</span>';
            phraseQueue.forEach((x,i) => {
                let e = document.createElement('div');
                e.className = 'timeline-item';
                e.innerHTML = `${x.name} <span class="text-xs text-amber-500">(${x.label})</span> <span onclick="event.stopPropagation();phraseQueue.splice(${i},1);renderTimeline()" class="cursor-pointer ml-2 text-red-500">x</span>`;
                d.appendChild(e);
            });
        }

        function playTimeline() {
            stopAll();
            let rootVal = document.getElementById('ph-root').value;
            let notes = getPhraseNotes(phraseQueue, rootVal);
            playPhraseSequence(notes);
        }
        
        function getPhraseNotes(queue, rootVal) {
             if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const r4 = getNoteIndex(rootVal+'4');
            const n = (o) => getNoteFromIndex(r4+o);
            let notes = [];
            
            queue.forEach(p => {
                let lastNote = notes.length > 0 ? notes[notes.length-1].n : null;
                let chunk = [];
                let shift = p.shift || 0;

                let pat = [];
                if(p.id==1) pat = [12,10,9,7,5,4,2,0]; 
                if(p.id==2) pat = [0,4,7,10,14,12,10,9]; 
                if(p.id==3) pat = [{o:2,d:0.1},{o:4,d:0.1},{o:5,d:0.1},{o:4,d:0.4}]; 
                if(p.id==4) pat = [-1,0,4,7,10,9,7]; 
                if(p.id==5) pat = [5,4,2,0,-1,9,7,5,4]; 
                if(p.id==6) pat = [12,4,7,11]; 

                chunk = pat.map(x => {
                    let off = (typeof x === 'object') ? x.o : x;
                    let dur = (typeof x === 'object') ? x.d : 0.2;
                    return {n: n(off + shift), d: dur};
                });

                if(lastNote && chunk.length>0 && chunk[0].n === lastNote) chunk.shift();
                notes = notes.concat(chunk);
            });
            return notes;
        }

        function playPhraseSequence(notes) {
            let accumulatedTime = 0;
            notes.forEach(e => {
                timeouts.push(setTimeout(() => {
                    highlight('piano-ph', [e.n], null);
                    playTone(FREQUENCIES[e.n], audioCtx.currentTime, e.d);
                    document.getElementById('disp-ph').innerText = e.n;
                }, accumulatedTime * 1000));
                accumulatedTime += e.d;
            });
        }

        // --- TAB 4: SUSTITUCIONES ---
        let subSel = {II:null, V:null, I:null};
        let bassMode = 'orig';
        function setBassMode(m) {
            bassMode = m;
            document.getElementById('bass-orig').className = m=='orig'?'px-3 py-1 text-xs rounded bg-blue-600 text-white border-blue-500':'px-3 py-1 text-xs rounded bg-zinc-700 text-gray-300 border-zinc-600';
            document.getElementById('bass-sub').className = m=='sub'?'px-3 py-1 text-xs rounded bg-blue-600 text-white border-blue-500':'px-3 py-1 text-xs rounded bg-zinc-700 text-gray-300 border-zinc-600';
        }

        const SUBS_RAW = {
            II: [
                {name:'F6/D', desc:'(b3, 5, b7, 9)'},
                {name:'B6/D', desc:'Dominante secundaria V/V'},
                {name:'D6', desc:'Dominante secundaria V/V.'},
                {name:'Ab6/D', desc:'para el 2 5 1 del menor o intercambio modal'}
            ],
            V: [
                {name:'G7', desc:'(1, 3, 5, b7)'},
                {name:'Bb7/G', desc:'(#9, 5, b7, b9)'},
                {name:'Db7/G', desc:'(b5, b7, b9, 3)'},
                {name:'E7/G', desc:'(13, b9, 3, 5)'},
                {name:'Dm6/G', desc:'(5, b7, 9, 3)'},
                {name:'Abm6/G', desc:'(b9, 3, b13, b7)'}
            ],
            I: [
                {name:'Cmaj7', desc:'(1, 3, 5, 7)'},
                {name:'C6', desc:'(1, 3, 5, 13)'},
                {name:'G6/C', desc:'Equivale a Cmaj7/9'}
            ]
        };

        function updateSubOptions() {
            const key = document.getElementById('sub-key').value;
            const off = getNoteIndex(key+'3') - getNoteIndex('C3');
            ['II','V','I'].forEach(deg => {
                const col = document.getElementById('col-'+deg.toLowerCase());
                col.innerHTML = '';
                SUBS_RAW[deg].forEach(item => {
                    let orig = item.name;
                    let label = orig.replace(/([A-G][b#]?)/g, match => {
                        let t = transpose(match+'3', off);
                        return t.slice(0,-1);
                    });
                    
                    let b = document.createElement('button');
                    b.className = 'sub-btn';
                    b.innerHTML = `<span class="chord-name">${label}</span><span class="chord-desc">${item.desc}</span>`;
                    b.onclick = (e) => {
                        col.querySelectorAll('.sub-btn').forEach(x=>x.classList.remove('selected'));
                        b.classList.add('selected');
                        subSel[deg] = label;
                        updateAnalysisPreview();
                    };
                    col.appendChild(b);
                });
            });
            subSel = {II:null, V:null, I:null};
            document.getElementById('analysis-preview').innerHTML = "<span class='text-zinc-500 italic'>Selecciona 3 acordes...</span>";
        }

        function getChordNotesSimple(name) {
            let parts = name.split('='); 
            let useName = parts.length > 1 ? parts[1] : parts[0];
            parts = useName.split('/');
            let chordPart = parts[0];
            let root = chordPart.match(/^[A-G][b#]?/)[0];
            let type = chordPart.replace(root, '');
            let rIdx = getNoteIndex(root+'3');
            let ints = [0,4,7,10]; 
            if(type.includes('m7')) ints=[0,3,7,10];
            else if(type.includes('maj7')) ints=[0,4,7,11];
            else if(type.includes('m6')) ints=[0,3,7,9];
            else if(type.includes('6')) ints=[0,4,7,9]; 
            return ints.map(i => getNoteFromIndex(rIdx+i));
        }

        function analyzeTensionsExact(chordNotes, bassNote, func) {
            const bassIdx = getNoteIndex(bassNote);
            const intervals = chordNotes.map(n => (getNoteIndex(n) - bassIdx + 120) % 12);
            let tensions = [];
            intervals.forEach(i => {
                if (i===0) tensions.push('1');
                else if(i===1) tensions.push('b9');
                else if(i===2) tensions.push('9');
                else if(i===3) tensions.push(func==='V'?'#9':'b3'); 
                else if(i===4) tensions.push('3');
                else if(i===5) tensions.push('11');
                else if(i===6) tensions.push('b5');
                else if(i===7) tensions.push('5');
                else if(i===8) tensions.push(func==='V'?'b13':'#5');
                else if(i===9) tensions.push(func==='I'?'13/6':'13');
                else if(i===10) tensions.push('b7');
                else if(i===11) tensions.push('7');
            });
            return [...new Set(tensions)].join(', ');
        }

        function updateAnalysisPreview() {
            if(!subSel.II || !subSel.V || !subSel.I) return;
            const strip = document.getElementById('analysis-preview');
            let seq = [subSel.II, subSel.V, subSel.I];
            let roots = ['II', 'V', 'I'];
            const key = document.getElementById('sub-key').value;
            const kIdx = getNoteIndex(key+'2');
            const origBass = [getNoteFromIndex(kIdx+2), getNoteFromIndex(kIdx+7), getNoteFromIndex(kIdx)];

            let html = "";
            seq.forEach((cName, i) => {
                let notes = getChordNotesSimple(cName);
                let bass = origBass[i]; 
                if(bassMode === 'sub') {
                     if(cName.includes('/')) {
                        let parts = cName.split('/');
                        let bName = parts[1].split('(')[0];
                        bass = bName+'2';
                        if(getNoteIndex(bass)<36) bass = transpose(bass,12);
                    } else {
                        let parts = cName.split('=');
                        let r = parts[0].match(/^[A-G][b#]?/)[0];
                        bass = r+'2';
                        if(getNoteIndex(bass)<36) bass = transpose(bass,12);
                    }
                }
                
                let tStr = analyzeTensionsExact(notes, bass, roots[i]);
                let cleanName = cName.split('=')[1] || cName; 
                if(cName.includes('/')) cleanName = cName; 

                html += `<div class="analysis-row"><div class="analysis-label text-amber-400">${roots[i]}:</div><div class="analysis-content">${cleanName} <span class="text-zinc-500">(${tStr})</span></div></div>`;
            });
            strip.innerHTML = `<div class="flex flex-col w-full px-4">${html}</div>`;
        }

        function playSelectedProgression() {
            if(!subSel.II || !subSel.V || !subSel.I) { alert("Selecciona 3 acordes"); return; }
            stopAll();
            updateAnalysisPreview();
            
            let inv = parseInt(document.getElementById('start-inv').value); 
            let seq = [subSel.II, subSel.V, subSel.I];
            let roots = ['II', 'V', 'I'];
            
            const key = document.getElementById('sub-key').value;
            const kIdx = getNoteIndex(key+'2');
            const origBass = [getNoteFromIndex(kIdx+2), getNoteFromIndex(kIdx+7), getNoteFromIndex(kIdx)];
            
            let t = 0;
            let prevNotes = null;

            seq.forEach((cName, i) => {
                timeouts.push(setTimeout(() => {
                    let notes = getChordNotesSimple(cName);
                    
                    if(i===0) {
                        while(getNoteIndex(notes[0]) < 48) notes = notes.map(n=>transpose(n,12));
                        for(let k=0; k<inv; k++) notes.push(transpose(notes.shift(), 12));
                    } else {
                        let prevCenter = prevNotes.reduce((s,n)=>s+getNoteIndex(n),0)/prevNotes.length;
                        let best = notes;
                        let minD = 9999;
                        let base = [...notes];
                        while(getNoteIndex(base[0]) < 48) base = base.map(n=>transpose(n,12));
                        let curr = [...base];
                        for(let k=0; k<4; k++) {
                            let c = curr.reduce((s,n)=>s+getNoteIndex(n),0)/curr.length;
                            if(Math.abs(c-prevCenter) < minD) { minD = Math.abs(c-prevCenter); best = [...curr]; }
                            curr.push(transpose(curr.shift(), 12));
                        }
                        notes = best;
                    }
                    prevNotes = notes;

                    let bass = "";
                    if (bassMode === 'sub') {
                        if(cName.includes('/')) {
                            let parts = cName.split('/');
                            let bName = parts[1].split('(')[0];
                            bass = bName+'2';
                        } else {
                            let parts = cName.split('=');
                            let r = parts[0].match(/^[A-G][b#]?/)[0];
                            bass = r+'2';
                        }
                    } else {
                         bass = origBass[i];
                    }
                    
                    if(getNoteIndex(bass)<36) bass = transpose(bass,12);
                    if(getNoteIndex(bass)>47) bass = transpose(bass,-12);

                    highlight('piano-sb', notes, bass); 
                    playChord(notes);
                    playTone(FREQUENCIES[bass], audioCtx.currentTime, 1.5);

                }, t));
                t += 1500;
            });
        }

        // --- TAB 5: DIMINUIDO ---
        function updateDimOrganic() {
            const root = document.getElementById('dim-root').value;
            const container = document.getElementById('dim-organic-container');
            const resultText = document.getElementById('dim-result-text');
            if(container) container.innerHTML = '';
            
            // Draw initial state (reset)
            if(resultText) resultText.innerText = "";
            if(document.getElementById('dim-reset-container')) document.getElementById('dim-reset-container').style.display = 'none';
            
            let rIdx = getNoteIndex(root+'3');
            // Dim intervals: 0, 3, 6, 9
            let dimNotes = [0, 3, 6, 9].map(i => getNoteFromIndex(rIdx+i));
            
            // Draw Dim chord initially
            highlight('piano-dm', dimNotes, 'highlighted-dim');
            if(document.getElementById('disp-dm')) document.getElementById('disp-dm').innerText = `${root}°7 (Familia)`;

            // UPDATE TRITONE LABELS
            let n0 = dimNotes[0].slice(0,-1);
            let n1 = dimNotes[1].slice(0,-1);
            let n2 = dimNotes[2].slice(0,-1);
            let n3 = dimNotes[3].slice(0,-1);

            document.getElementById('tri-lbl-0-main').innerText = `Subir ${n0} y ${n2}`;
            document.getElementById('tri-lbl-0-notes').innerText = `(Par 1: ${n0} y ${n2})`;
            
            document.getElementById('tri-lbl-1-main').innerText = `Subir ${n1} y ${n3}`;
            document.getElementById('tri-lbl-1-notes').innerText = `(Par 2: ${n1} y ${n3})`;

            dimNotes.forEach(n => {
                let card = document.createElement('div');
                card.className = 'dim-note-col'; 
                
                let btnUp = document.createElement('div');
                btnUp.className = 'dim-btn-action up';
                btnUp.innerHTML = '▲ Subir';
                btnUp.onclick = () => {
                    let newNote = transpose(n, 1);
                    // Raising creates m6/m7b5 related.
                    let newChord = dimNotes.map(x => x===n ? newNote : x);
                    let rootm7b5 = transpose(newNote, 2).slice(0,-1);
                    playTransform(newChord, `${rootm7b5}m7(b5)`);
                };

                let noteDisp = document.createElement('div');
                noteDisp.className = 'dim-note-display';
                noteDisp.innerText = n.slice(0,-1);

                let btnDown = document.createElement('div');
                btnDown.className = 'dim-btn-action down';
                btnDown.innerHTML = '▼ Bajar';
                btnDown.onclick = () => {
                    let newNote = transpose(n, -1);
                    // Lowering creates Dom7
                    let newChord = dimNotes.map(x => x===n ? newNote : x);
                    let rootName = newNote.slice(0,-1);
                    playTransform(newChord, `${rootName}7`);
                };

                card.appendChild(btnUp);
                card.appendChild(noteDisp);
                card.appendChild(btnDown);
                if(container) container.appendChild(card);
            });
        }

        // Nueva función para 7b5 (Tritonos)
        function transformTritone(pairIdx) {
            const root = document.getElementById('dim-root').value;
            let rIdx = getNoteIndex(root+'3');
            let dimNotes = [0, 3, 6, 9].map(i => getNoteFromIndex(rIdx+i));

            // Indices to move (Pair 1: 0,2 | Pair 2: 1,3)
            let moveIndices = pairIdx === 0 ? [0, 2] : [1, 3];
            // Indices that stay (become roots of the tritone subs)
            let staticIndices = pairIdx === 0 ? [1, 3] : [0, 2];

            let newChord = dimNotes.map((n, i) => {
                if(moveIndices.includes(i)) return transpose(n, 1);
                return n;
            });

            // Get names of static notes to name the 7b5 chords
            let root1 = dimNotes[staticIndices[0]].slice(0, -1);
            let root2 = dimNotes[staticIndices[1]].slice(0, -1);

            playTransform(newChord, `${root1}7(b5) / ${root2}7(b5)`);
        }
        
        function playTransform(notes, label) {
            stopAll();
            highlight('piano-dm', notes, 'highlighted');
            playChord(notes);
            if(document.getElementById('disp-dm')) document.getElementById('disp-dm').innerText = label;
            if(document.getElementById('dim-result-text')) document.getElementById('dim-result-text').innerText = label;
            if(document.getElementById('dim-reset-container')) document.getElementById('dim-reset-container').style.display = 'block';

            // Actualizar visualización de las notas (Círculos morados)
            const displayEls = document.querySelectorAll('.dim-note-display');
            if (displayEls.length === notes.length) {
                notes.forEach((n, i) => {
                    displayEls[i].innerText = n.slice(0, -1); // Quitar octava
                });
            }
        }

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            updateExtraNoteOptions();
            drawPiano('piano-sc');
            updateChordGrid();
            updateSubOptions();
            setBassMode('orig');
        });
    </script>
</body>
</html>
